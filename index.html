<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sistema de Gesti√≥n Energ√©tica</title>
  <link rel="icon" href="logo puerto.png" type="image/png">

  <!-- Chart.js + Zoom Plugin -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter&display=swap');

    /* Variables CSS para temas claro/oscuro */
    :root {
      --color-bg-light: #fff;
      --color-text-light: #333;
      --color-bg-dark: #0f172a;
      --color-surface-dark: #1e293b;
      --color-text-dark: #e2e8f0;
      --color-primary: #0a3d66;
      --color-primary-light: #0a72c1;
      --color-accent: #ffc72c;
      --color-table-header-bg-light: var(--color-primary);
      --color-table-header-bg-dark: #144372;
      --shadow-card: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    body {
      background-color: var(--color-bg-light);
      color: var(--color-text-light);
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding: 30px 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      transition: background-color 0.4s ease, color 0.4s ease;
    }
    body.dark-mode {
      background-color: var(--color-bg-dark);
      color: var(--color-text-dark);
    }
    #logo-fijo {
      width: 120px;
      height: auto;
      transition: filter 0.4s ease;
    }
    h1 {
      margin: 0;
      color: var(--color-primary);
      font-weight: 700;
      font-size: 2rem;
      text-align: left;
      user-select: none;
      transition: color 0.4s ease;
    }
    body.dark-mode h1 {
      color: var(--color-text-dark);
    }
    h2 {
      color: var(--color-primary);
      transition: color 0.4s ease;
    }
    body.dark-mode h2 {
      color: var(--color-text-dark);
    }
    canvas {
      background-color: #f5faff;
      border-radius: 12px;
      box-shadow: 0 0 15px rgba(10, 61, 102, 0.2);
      display: block;
      margin: 0 auto 25px auto;
      width: 100% !important;
      max-width: 1600px;
      height: auto !important;
      transition: background-color 0.4s ease;
    }
    body.dark-mode canvas {
      background-color: #cbd5e1; /* Gris azulado claro para contraste con texto oscuro */
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
      filter: brightness(0.95);
    }
    #controls {
      text-align: center;
      margin-bottom: 30px;
    }
    button {
      background: none;
      border: 2px solid var(--color-primary);
      color: var(--color-primary);
      cursor: pointer;
      margin: 0 12px;
      padding: 8px;
      border-radius: 6px;
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    button:hover:not(:disabled) {
      background-color: var(--color-primary);
      color: #fff;
    }
    button:disabled {
      border-color: #bbb;
      color: #bbb;
      cursor: not-allowed;
      opacity: 0.7;
    }
    body.dark-mode button {
      border-color: var(--color-text-dark);
      color: var(--color-text-dark);
    }
    body.dark-mode button:hover:not(:disabled) {
      background-color: var(--color-text-dark);
      color: var(--color-primary);
    }
    svg {
      width: 32px;
      height: 32px;
      fill: currentColor;
      user-select: none;
    }
    #peakHistoryTable {
      width: 100%;
      max-width: 1600px;
      border-collapse: separate;
      border-spacing: 0 8px;
      color: var(--color-text-light);
      font-size: 16px;
      box-shadow: 0 0 15px rgba(10, 61, 102, 0.15);
      border-radius: 12px;
      overflow: hidden;
      background: #fafcff;
      transition: background-color 0.4s ease, color 0.4s ease;
    }
    body.dark-mode #peakHistoryTable {
      background: var(--color-surface-dark);
      color: var(--color-text-dark);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }
    thead tr {
      background-color: var(--color-table-header-bg-light);
      color: #fff;
      text-align: left;
      user-select: none;
      transition: background-color 0.4s ease;
    }
    body.dark-mode thead tr {
      background-color: var(--color-table-header-bg-dark);
    }
    th, td {
      padding: 14px 20px;
    }
    tbody tr {
      background-color: #e6f0fc;
      transition: background-color 0.2s ease;
      border-radius: 10px;
      user-select: text;
    }
    body.dark-mode tbody tr {
      background-color: #334155;
      border-bottom: 1px solid #475569;
    }
    tbody tr:hover {
      background-color: #c7dbf8;
    }
    body.dark-mode tbody tr:hover {
      background-color: #475569;
    }
    tbody tr td {
      border-bottom: none;
    }
    #pagination {
      width: 100%;
      max-width: 1600px;
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 18px;
      color: var(--color-primary);
      font-size: 1rem;
      user-select: none;
      gap: 15px;
      transition: color 0.4s ease;
    }
    body.dark-mode #pagination {
      color: var(--color-text-dark);
    }
    #pageInfo {
      font-weight: 600;
      color: var(--color-primary);
      transition: color 0.4s ease;
    }
    body.dark-mode #pageInfo {
      color: var(--color-text-dark);
    }

    /* Indicador de conexi√≥n */
    #connectionStatus {
      display: flex;
      align-items: center;
      padding: 8px 16px;
      background-color: rgba(255, 255, 255, 0.6);
      border: 1px solid rgba(0,0,0,0.1);
      border-radius: 30px;
      font-size: 0.9rem;
      font-weight: 700;
      margin-right: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      user-select: none;
      transition: all 0.3s ease;
      white-space: nowrap;
    }
    body.dark-mode #connectionStatus {
      background-color: rgba(30, 41, 59, 0.8);
      border-color: #475569;
      color: #e2e8f0;
    }
    /* LED de estado */
    .status-led {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
      background-color: #ccc;
      vertical-align: middle;
      transition: background-color 0.3s, box-shadow 0.3s;
    }
    /* Clases para colores de estado */
    .status-connected .status-led { background-color: #28a745; box-shadow: 0 0 8px #28a745; animation: pulse-green 2s infinite; }
    .status-connected { color: #28a745 !important; }
    
    .status-disconnected .status-led { background-color: #dc3545; box-shadow: none; animation: none; }
    .status-disconnected { color: #dc3545 !important; }
    
    .status-reconnecting .status-led { background-color: #ffc107; box-shadow: none; animation: none; }
    .status-reconnecting { color: #ffc107 !important; }
    
    /* Estado de advertencia (Sin datos) */
    .status-warning .status-led { background-color: #fd7e14; box-shadow: none; animation: none; }
    .status-warning { color: #fd7e14 !important; }
    
    @keyframes pulse-green {
      0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7); }
      70% { box-shadow: 0 0 0 6px rgba(40, 167, 69, 0); }
      100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
    }

    /* Toggle modo oscuro */
    #darkModeToggle {
      background: var(--color-primary);
      color: #fff;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: background-color 0.3s ease;
      user-select: none;
    }
    #darkModeToggle:hover {
      background-color: var(--color-primary-light);
    }
    body.dark-mode #darkModeToggle {
      background: var(--color-text-dark);
      color: var(--color-primary);
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.4);
    }
    body.dark-mode #darkModeToggle:hover {
      background-color: #e2e8f0;
    }

    /* Bot√≥n de Informe - Estilos mejorados */
    #reportBtn {
      background-color: #28a745;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
    }
    #reportBtn:hover {
      background-color: #218838; /* Verde m√°s oscuro al pasar el mouse */
      transform: translateY(-2px); /* Efecto de elevaci√≥n */
      box-shadow: 0 4px 8px rgba(40, 167, 69, 0.4); /* Sombra suave */
    }

    /* Alertas */
    #alertContainer {
      display:none; max-width:1600px; margin: 0 auto 20px; padding:10px; border-radius:6px;
      background:#ff4c4c; color:#fff; font-weight:bold; text-align:center; font-size:1.2rem;
      user-select:none; box-shadow: 0 0 15px rgba(255,0,0,0.5);
    }
    #alertHistory {
      display:none; max-width:1600px; margin: 0 auto 30px; background:#faf0f0; border:1px solid #ff4c4c;
      border-radius:6px; padding:10px; max-height: 150px; overflow-y: auto;
      font-family: monospace; font-size: 0.9rem; color:#900;
    }
    #toggleAlertsBtn {
      margin-bottom:15px; display:none; cursor:pointer; background:#0a3d66; color:#fff;
      padding:8px 14px; border:none; border-radius:6px; font-weight:600; user-select:none;
    }
    #toggleAlertsBtn:hover {
      background: #0a72c1;
    }
    body.dark-mode #alertHistory {
      background: var(--color-surface-dark); color: #fca5a5; border-color: #ef4444;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }
    body.dark-mode #toggleAlertsBtn {
      background: var(--color-text-dark); color: var(--color-primary);
      box-shadow: none;
    }
    body.dark-mode #toggleAlertsBtn:hover {
      background-color: #e2e8f0;
    }

    /* Estilos para los recuadros de STS */
    .sts-box {
      position: relative; /* Necesario para posicionar el icono absoluto */
      padding: 20px;
      background-color: #76acdf;
      text-align: center;
      border-radius: 16px;
      color: #fff;
      box-shadow: var(--shadow-card);
      transition: transform 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 140px;
    }
    /* Iconos decorativos */
    .card-icon {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 40px;
      height: 40px;
      opacity: 0.2; /* Transparencia para que sea sutil */
      color: #fff;
      pointer-events: none;
    }
    .sts-box:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    .sts-title {
      font-size: 1.2rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      opacity: 0.9;
      font-weight: bold;
      margin-bottom: 10px;
      color: #0a3d66;
    }
    .sts-data {
      font-size: 2rem;
      font-weight: bold;
      line-height: 1.2;
      text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .sts-unit { font-size: 1rem; font-weight: normal; margin-left: 5px; }
    .slow-down-legend {
      font-size: 0.9rem;
      font-weight: bold;
      color: #fff;
      margin-top: 10px;
      background-color: rgba(0,0,0,0.2);
      padding: 4px;
      border-radius: 4px;
    }

    /* Layout Grid */
    .main-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
      max-width: 1600px;
      margin-bottom: 25px;
      padding: 15px 25px;
      background: rgba(255,255,255,0.85);
      backdrop-filter: blur(12px);
      border-radius: 20px;
      box-shadow: var(--shadow-card);
      gap: 20px;
      flex-wrap: wrap;
    }
    .header-left {
      display: flex;
      align-items: center;
      gap: 20px;
    }
    .header-info {
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    .header-controls {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    body.dark-mode .main-header {
      background: rgba(30, 41, 59, 0.9);
      border-bottom: 1px solid #334155;
    }
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      width: 100%;
      max-width: 1600px;
      margin-bottom: 30px;
    }
    .dashboard-grid.main-metrics {
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    }

    /* Media Queries para m√≥viles y tablets */
    @media (max-width: 768px) {
      body { padding: 15px 5px; }
      h1 { font-size: 1.3rem; }
      h2 { font-size: 1rem; }
      #logo-fijo { width: 70px; }

      .dashboard-grid { gap: 8px; }
      .dashboard-grid, .dashboard-grid.main-metrics {
        grid-template-columns: repeat(2, 1fr); /* Forzar 2 columnas para un layout m√°s limpio y legible */
      }

      .sts-box { padding: 10px; min-height: 100px; border-radius: 12px; }
      .sts-title { font-size: 0.8rem; margin-bottom: 5px; }
      .sts-data { font-size: 1.3rem; }
      .sts-unit { font-size: 0.75rem; }
      .last-slow-info { font-size: 0.7rem; padding: 4px 6px; margin-top: 8px; }

      #connectionStatus { font-size: 0.8rem; margin-right: 0; margin-bottom: 10px; width: 100%; justify-content: center; }
      button { margin: 0 2px; padding: 6px 8px; font-size: 0.8rem; }
      .main-header {
        flex-direction: column;
        align-items: stretch;
        padding: 15px;
        gap: 15px;
      }
      .header-left {
        width: 100%;
        justify-content: flex-start;
      }
      .header-controls {
        width: 100%;
        justify-content: space-between;
        flex-wrap: wrap;
      }
      .header-controls button {
        flex: 1;
      }

      /* Table adjustments */
      .table-container {
        width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        border: 1px solid #ddd;
        border-radius: 8px;
      }
      body.dark-mode .table-container { border-color: #475569; }
      #peakHistoryTable { white-space: nowrap; }
      th, td { padding: 10px 15px; }
      #pagination { gap: 5px; }

      footer { font-size: 0.8rem; margin-top: 30px; }
    }
    
    /* Estilo para el recuadro de informaci√≥n de Slow Down */
    .last-slow-info {
      margin-top: 12px;
      font-size: 0.85rem;
      background-color: rgba(0, 0, 0, 0.2);
      padding: 6px 10px;
      border-radius: 8px;
      width: 100%;
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-sizing: border-box;
      display: none;
    }

    .table-container {
      width: 100%;
      max-width: 1600px;
      margin: 0 auto;
    }

    /* Estilos para impresi√≥n (Generaci√≥n de Informe) */
    @media print {
      @page { margin: 0.5cm; size: landscape; }
      body {
        background-color: #fff !important;
        color: #000 !important;
        padding: 0 !important;
      }
      .main-header {
        box-shadow: none !important;
        background: none !important;
        border-bottom: 2px solid #0a3d66;
        margin-bottom: 20px;
      }
      /* Mostrar fecha de reporte solo en impresi√≥n */
      .print-only {
        display: block !important;
        font-size: 0.9rem;
        margin-top: 5px;
      }
      /* Ocultar botones y elementos de navegaci√≥n */
      #darkModeToggle, #reportBtn, #vesselBtn, .btn-history, #pagination, #connectionStatus, #dataStatus, #btnPrev, #btnNext, #alertContainer {
        display: none !important;
      }

      /* 1. Forzar que todas las tarjetas queden en la primera hoja */
      .dashboard-grid {
        margin-bottom: 10px !important;
        gap: 10px !important;
      }
      /* Forzar 4 columnas para la primera fila (M√©tricas principales) */
      .dashboard-grid.main-metrics {
        grid-template-columns: repeat(4, 1fr) !important;
      }
      /* Forzar 5 columnas para la segunda fila (Gr√∫as STS) */
      .dashboard-grid:nth-of-type(2) {
        grid-template-columns: repeat(5, 1fr) !important;
      }

      /* Reducir tama√±o de tarjetas para impresi√≥n */
      .sts-box {
        min-height: 80px !important;
        padding: 10px !important;
      }
      .sts-data {
        font-size: 1.4rem !important;
      }

      /* Ajustar gr√°ficas y tablas */
      canvas {
        display: block !important;
        max-width: 100% !important;
        height: auto !important;
        break-inside: avoid;
      }
      .sts-box {
        break-inside: avoid;
        page-break-inside: avoid;
        box-shadow: none !important;
        border: 1px solid #eee;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
      #peakHistoryTable {
        box-shadow: none !important;
        border: 1px solid #ccc;
        width: 100%;
        border-collapse: collapse !important; /* Tabla compacta tipo Excel */
        border-spacing: 0 !important;
      }
      #peakHistoryTable th, #peakHistoryTable td {
        border: 1px solid #000 !important; /* Bordes negros finos */
        padding: 8px !important;
        color: #000 !important;
      }
      #peakHistoryTable th {
        background-color: #f0f0f0 !important; /* Encabezado gris claro */
      }
      footer {
        position: static !important;
        margin-top: auto !important;
      }
      #print-page-one {
        min-height: 98vh;
        display: flex;
        flex-direction: column;
        page-break-after: always;
      }
      #print-page-two {
        min-height: 98vh;
        display: flex;
        flex-direction: column;
      }
      .print-footer-page1 {
        display: block !important;
        text-align: center;
        margin-top: auto;
        padding-bottom: 10px;
        font-size: 0.9rem;
        opacity: 0.8;
      }

      /* Estilos para imprimir solo el modal KWH */
      body.printing-modal > *:not(#kwhModal) { display: none !important; }
      body.printing-modal #kwhModal {
        display: block !important;
        position: static !important;
        width: 100% !important;
        height: auto !important;
        background: #fff !important;
        overflow: visible !important;
      }
      body.printing-modal #kwhModal .modal-content {
        border: none !important;
        box-shadow: none !important;
        width: 100% !important;
        max-width: 100% !important;
        margin: 0 !important;
        padding: 0 !important;
      }
      body.printing-modal .close-modal,
      body.printing-modal .btn-export,
      body.printing-modal #kwhPagination {
        display: none !important;
      }
      body.printing-modal .table-container {
        max-height: none !important;
        overflow: visible !important;
      }
      body.printing-modal #kwhReportTimestamp {
        display: block !important;
        font-size: 0.9rem;
        margin-bottom: 15px;
        color: #333;
      }
      .print-footer-kwh {
        display: block !important;
      }
      .print-header-kwh {
        display: flex !important;
        align-items: center;
        gap: 20px;
        margin-bottom: 20px;
        border-bottom: 2px solid #0a3d66;
        padding-bottom: 15px;
      }
      .print-header-kwh img {
        width: 100px;
        height: auto;
      }
      .print-header-kwh h1 {
        margin: 0;
        font-size: 1.8rem;
        color: #0a3d66;
        font-weight: 700;
      }
    }

    .print-only {
      display: none;
    }
    .print-footer-page1 {
      display: none;
    }

    /* Estilos para el Modal de Historial KWH */
    .modal {
      display: none; 
      position: fixed; 
      z-index: 9999; 
      left: 0; 
      top: 0; 
      width: 100%; 
      height: 100%; 
      overflow: auto; 
      background-color: rgba(0,0,0,0.6); 
      backdrop-filter: blur(4px);
    }
    .modal-content {
      background-color: #fefefe;
      margin: 2% auto; 
      padding: 20px;
      border: 1px solid #888;
      width: 98%; 
      max-width: 1800px;
      border-radius: 12px;
      position: relative;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      animation: fadeIn 0.3s;
    }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
    body.dark-mode .modal-content { background-color: var(--color-surface-dark); color: var(--color-text-dark); border-color: #475569; }
    .close-modal { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
    .close-modal:hover { color: #000; }
    body.dark-mode .close-modal:hover { color: var(--color-text-dark); }
    
    .kwh-list { list-style: none; padding: 0; margin-top: 15px; max-height: 400px; overflow-y: auto; }
    .kwh-list li { padding: 10px 0; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
    body.dark-mode .kwh-list li { border-bottom-color: #334155; }
    .kwh-list li:last-child { border-bottom: none; }
    
    .btn-history {
      margin-top: 10px;
      background: rgba(255,255,255,0.2);
      border: 1px solid rgba(255,255,255,0.6);
      color: #fff;
      padding: 5px 10px;
      border-radius: 6px;
      margin-top: 15px;
      background-color: #fff;
      color: var(--color-primary);
      border: none;
      padding: 8px 12px;
      border-radius: 25px;
      cursor: pointer;
      font-size: 0.85rem;
      transition: background 0.3s, transform 0.2s;
      font-size: 0.8rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      box-shadow: 0 3px 6px rgba(0,0,0,0.15);
      transition: all 0.2s ease;
      width: 100%;
    }
    .btn-history:hover { background: rgba(255,255,255,0.4); transform: translateY(-1px); }
    .btn-history:hover { 
      background-color: #f8f9fa; 
      transform: translateY(-2px);
      box-shadow: 0 5px 10px rgba(0,0,0,0.2);
    }
    body.dark-mode .btn-history {
      background-color: var(--color-text-dark);
      color: var(--color-primary);
    }

    .chart-container-modal {
      position: relative; height: 250px; flex: 1; min-width: 300px;
    }
    
    .charts-wrapper {
      display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 20px;
    }

    /* Estilos mejorados para el Modal KWH */
    .chart-container-modal {
      position: relative; 
      height: 300px; 
      flex: 1; 
      min-width: 400px;
      background: #fff;
      padding: 15px;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.05);
      border: 1px solid rgba(0,0,0,0.05);
      transition: transform 0.2s;
    }
    .chart-container-modal:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 25px rgba(0,0,0,0.08);
    }
    body.dark-mode .chart-container-modal {
      background: #1e293b;
      border-color: #334155;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }

    .daily-total-box {
      background: linear-gradient(135deg, #0a72c1, #0056b3);
      color: #fff;
      padding: 25px;
      border-radius: 16px;
      text-align: center;
      margin-bottom: 25px;
      border: none;
      box-shadow: 0 8px 20px rgba(10, 114, 193, 0.25);
      position: relative;
      overflow: hidden;
    }
    .daily-total-label {
      font-size: 0.95rem;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      opacity: 0.9;
      margin-bottom: 8px;
      font-weight: 600;
    }
    .daily-total-value {
      font-size: 2.8rem;
      font-weight: 800;
      text-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }

    /* Estilos para la tabla del modal KWH */
    #kwhHistoryTable {
      width: 100%;
      border-collapse: separate; 
      border-spacing: 0;
      margin-top: 15px;
      font-size: 0.95rem;
    }
    #kwhHistoryTable th {
      background-color: #f8fafc;
      color: #475569;
      font-weight: 700;
      text-transform: uppercase;
      font-size: 0.8rem;
      padding: 15px;
      border-bottom: 2px solid #e2e8f0;
      position: sticky; 
      top: 0;
      z-index: 10;
    }
    #kwhHistoryTable td {
      padding: 15px;
      border-bottom: 1px solid #f1f5f9;
      color: #334155;
    }
    #kwhHistoryTable tr:last-child td { border-bottom: none; }
    
    body.dark-mode #kwhHistoryTable th {
      background-color: #0f172a;
      color: #94a3b8;
      border-bottom-color: #334155;
    }
    body.dark-mode #kwhHistoryTable td {
      border-bottom-color: #334155;
      color: #e2e8f0;
    }
    
    body.dark-mode .daily-total-box {
      background: linear-gradient(135deg, #1e293b, #0f172a);
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
    }

    /* Loader Moderno */
    .loader {
      width: 40px;
      height: 40px;
      margin: 20px auto;
      border-radius: 50%;
      border: 3px solid rgba(10, 61, 102, 0.1);
      border-top-color: var(--color-primary);
      animation: spin 0.8s ease-in-out infinite;
      display: none;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Bot√≥n Exportar */
    .btn-export {
      background-color: #28a745;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 5px;
      float: right;
      margin-bottom: 10px;
    }
    .btn-export:hover { background-color: #218838; }

    /* Inputs Grid Mejorado */
    .vessel-inputs {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
      align-items: flex-end;
    }
    
    .vessel-group { display: flex; flex-direction: column; }
    .vessel-group label { 
      font-size: 0.9rem; 
      font-weight: 600; 
      margin-bottom: 8px; 
      color: var(--color-text-light); 
    }
    body.dark-mode .vessel-group label { color: var(--color-text-dark); }
    
    .vessel-group input { 
      padding: 10px 12px; 
      border: 1px solid #ccc; 
      border-radius: 6px; 
      font-size: 0.95rem; 
      background-color: #fff;
      color: #333;
      transition: border-color 0.3s, box-shadow 0.3s;
      width: 100%;
      box-sizing: border-box;
    }
    body.dark-mode .vessel-group input {
      background-color: #0f172a;
      border-color: #475569;
      color: #fff;
    }
    .vessel-group input:focus {
      outline: none;
      border-color: var(--color-primary-light);
      box-shadow: 0 0 0 3px rgba(10, 114, 193, 0.2);
    }

    .btn-calc { 
      height: 42px;
      font-size: 1rem;
      background-color: var(--color-accent); 
      color: #000; 
      border: none; 
      border-radius: 6px;
      font-weight: 700; 
      cursor: pointer;
      transition: background 0.3s, transform 0.2s;
      width: 100%;
    }
    .btn-calc:hover { 
      background-color: #e0a800; 
      transform: translateY(-1px);
    }
    body.dark-mode .btn-calc {
      background-color: var(--color-text-dark);
      color: var(--color-primary);
    }
    body.dark-mode .btn-calc:hover {
      background-color: #e2e8f0;
    }

    /* Estilos para el Modal de Buque y Resultados */
    .modal-header-custom {
      background-color: var(--color-primary);
      color: #fff;
      padding: 15px 20px;
      border-radius: 12px 12px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-header-custom h2 { margin: 0; font-size: 1.4rem; color: #fff; }
    body.dark-mode .modal-header-custom h2 { color: var(--color-text-dark); }
    body.dark-mode .modal-header-custom { background-color: #1e293b; border-bottom: 1px solid #334155; }
    
    .modal-body-custom { padding: 20px; }

    .analysis-info {
      background-color: #f8f9fa;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      border-left: 5px solid var(--color-primary);
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    body.dark-mode .analysis-info { background-color: var(--color-surface-dark); border-left-color: var(--color-text-dark); }
    
    .analysis-header { font-size: 1.1rem; font-weight: 700; margin-bottom: 10px; color: var(--color-primary); border-bottom: 1px solid #ddd; padding-bottom: 5px; }
    body.dark-mode .analysis-header { color: var(--color-text-dark); border-bottom-color: #334155; }
    
    .analysis-dates { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .date-item strong { display: block; font-size: 0.85rem; color: #666; margin-bottom: 3px; }
    body.dark-mode .date-item strong { color: #ccc; }
    .date-value { font-weight: 600; font-size: 1rem; }

    .kpi-card {
      background: linear-gradient(135deg, #28a745, #218838);
      color: white;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      margin-bottom: 25px;
      box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
    }
    .kpi-label { font-size: 1.1rem; opacity: 0.95; margin-bottom: 5px; font-weight: 600; }
    .kpi-value { font-size: 2.5rem; font-weight: 800; text-shadow: 0 2px 4px rgba(0,0,0,0.2); }

    /* Estilos para tarjetas de Mayor/Menor Consumo */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 15px;
      margin-bottom: 25px;
    }
    .stat-card {
      background-color: #fff;
      border-radius: 10px;
      padding: 15px;
      display: flex;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border: 1px solid #eee;
      transition: transform 0.2s;
    }
    .stat-card:hover { transform: translateY(-2px); }
    body.dark-mode .stat-card { background-color: var(--color-surface-dark); border-color: #334155; }
    
    .stat-icon { font-size: 2rem; margin-right: 15px; width: 40px; text-align: center; }
    .stat-info { display: flex; flex-direction: column; }
    .stat-label { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px; color: #666; font-weight: 700; margin-bottom: 2px; }
    body.dark-mode .stat-label { color: #ccc; }
    .stat-value { font-size: 1.2rem; font-weight: 800; color: #333; }
    body.dark-mode .stat-value { color: var(--color-text-dark); }
    .stat-sub { font-size: 0.9rem; color: #666; }
    body.dark-mode .stat-sub { color: #bbb; }
    
    .max-stat { border-left: 5px solid #dc3545; }
    .min-stat { border-left: 5px solid #28a745; }

    /* Alertas de An√°lisis */
    .analysis-alert {
      background-color: #fff3cd;
      color: #856404;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 20px;
      border: 1px solid #ffeeba;
      font-size: 0.9rem;
    }
    .analysis-alert div { margin-bottom: 5px; }
    .analysis-alert div:last-child { margin-bottom: 0; }
    body.dark-mode .analysis-alert {
      background-color: #422006;
      color: #fcd34d;
      border-color: #78350f;
    }
  </style>
</head>
<body>
  <div id="print-page-one">
  <header class="main-header">
    <div class="header-left">
      <img id="logo-fijo" src="logo puerto.png" alt="Logo" />
      <div class="header-info">
        <h1>Sistema de Gesti√≥n Energ√©tica</h1>
        <div id="reportTimestamp" class="print-only"></div>
      </div>
    </div>
    <div class="header-controls">
      <div id="connectionStatus"><span class="status-led"></span><span id="connText">Desconectado</span></div>
      <button id="reportBtn">üìÑ Informe</button>
      <button id="vesselBtn" onclick="openVesselModal()">üö¢ An√°lisis Buque</button>
      <button id="darkModeToggle" title="Alternar modo oscuro">Modo oscuro</button>
    </div>
  </header>

  <!-- Recuadros Principales -->
  <div class="dashboard-grid main-metrics">
    <div id="topic1-cell" class="sts-box" style="background: linear-gradient(135deg, #0a72c1, #0a3d66);">
      <!-- Icono Rayo -->
      <svg class="card-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"></path></svg>
      <div class="sts-title" style="color: #fff;">Medidor CGE</div>
      <div id="topic1Loader" class="loader" style="display: block; border-color: rgba(255,255,255,0.2); border-top-color: #fff;"></div>
      <div id="topic1Content" style="display: none;">
        <div id="topic1" class="sts-data">-- <span class="sts-unit">Amp</span></div>
      </div>
    </div>
    <div id="topic2-cell" class="sts-box" style="background: linear-gradient(135deg, #ffc72c, #e0a800);">
      <!-- Icono Actividad/Pulso -->
      <svg class="card-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>
      <div class="sts-title" style="color: #fff;">Consumo Gr√∫as</div>
      <div id="topic2Loader" class="loader" style="display: block; border-color: rgba(255,255,255,0.2); border-top-color: #fff;"></div>
      <div id="topic2Content" style="display: none;">
        <div id="topic2" class="sts-data">-- <span class="sts-unit">Amp</span></div>
      </div>
    </div>
    <div id="last-peak-cell" class="sts-box" style="background: linear-gradient(135deg, #dc3545, #c82333);">
      <!-- Icono Tendencia Subida -->
      <svg class="card-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>
      <div class="sts-title" style="color: #fff;">√öltimo Peak</div>
      <div id="lastPeakLoader" class="loader" style="display: block; border-color: rgba(255,255,255,0.2); border-top-color: #fff;"></div>
      <div id="lastPeakContent" style="display: none;">
        <div id="lastPeakValue" class="sts-data">-- <span class="sts-unit">Amp</span></div>
        <div id="lastPeakDate" class="sts-data" style="font-size: 1.1rem; margin-top: 5px; font-weight: 400;">--</div>
      </div>
    </div>
    <div id="topic8-cell" class="sts-box" style="background-color: #28a745;">
      <!-- Icono Viento -->
      <svg class="card-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9.59 4.59A2 2 0 1 1 11 8H2m10.59 11.41A2 2 0 1 0 14 16H2m15.73-8.27A2.5 2.5 0 1 1 19.5 12H2"/></svg>
      <div class="sts-title">Viento</div>
      <div id="topic8Loader" class="loader" style="display: block; border-color: rgba(255,255,255,0.2); border-top-color: #fff;"></div>
      <div id="topic8Content" style="display: none;">
        <div id="Viento_STS1" class="sts-data" style="font-size: 2.5rem;">-- <span class="sts-unit">m/s</span></div>
        <div id="topic8" class="sts-data" style="font-size: 1.2rem; margin-top: 5px;">-- <span class="sts-unit">Nudos</span> | -- <span class="sts-unit">km/h</span></div>
      </div>
      <!-- <div class="slow-down-legend" style="display: none;">GRUA EN SLOW DOWN</div> -->
    </div>
  </div>
  
   <!-- Nuevos topics I_STS1, I_STS2, I_STS3, I_STS4, I_STS5 -->
  <div class="dashboard-grid">
    <div id="topic3-cell" class="sts-box">
      <!-- Icono Ancla (STS1) -->
      <svg class="card-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="5" r="3"></circle><line x1="12" y1="22" x2="12" y2="8"></line><path d="M5 12H2a10 10 0 0 0 20 0h-3"></path></svg>
      <div class="sts-title">STS1</div>
      <div id="topic3Loader" class="loader" style="display: block; border-color: rgba(255,255,255,0.2); border-top-color: #fff;"></div>
      <div id="topic3Content" style="display: none;">
        <div id="topic3" class="sts-data">-- <span class="sts-unit">Amp</span></div>
        <div id="kwh_sts1" class="sts-data">-- <span class="sts-unit">kWh</span></div>
        <div class="slow-down-legend" style="display: none;">GRUA EN SLOW DOWN</div>
        <div id="last_slow_sts1" class="last-slow-info"></div>
        <button class="btn-history" onclick="openHistory(1)">üìä Ver Historial KWH</button>
      </div>
    </div>
    <div id="topic4-cell" class="sts-box">
      <!-- Icono Ancla (STS2) -->
      <svg class="card-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="5" r="3"></circle><line x1="12" y1="22" x2="12" y2="8"></line><path d="M5 12H2a10 10 0 0 0 20 0h-3"></path></svg>
      <div class="sts-title">STS2</div>
      <div id="topic4Loader" class="loader" style="display: block; border-color: rgba(255,255,255,0.2); border-top-color: #fff;"></div>
      <div id="topic4Content" style="display: none;">
        <div id="topic4" class="sts-data">-- <span class="sts-unit">Amp</span></div>
        <div id="kwh_sts2" class="sts-data">-- <span class="sts-unit">kWh</span></div>
        <div class="slow-down-legend" style="display: none;">GRUA EN SLOW DOWN</div>
        <div id="last_slow_sts2" class="last-slow-info"></div>
        <button class="btn-history" onclick="openHistory(2)">üìä Ver Historial KWH</button>
      </div>
    </div>
    <div id="topic5-cell" class="sts-box">
      <!-- Icono Ancla (STS3) -->
      <svg class="card-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="5" r="3"></circle><line x1="12" y1="22" x2="12" y2="8"></line><path d="M5 12H2a10 10 0 0 0 20 0h-3"></path></svg>
      <div class="sts-title">STS3</div>
      <div id="topic5Loader" class="loader" style="display: block; border-color: rgba(255,255,255,0.2); border-top-color: #fff;"></div>
      <div id="topic5Content" style="display: none;">
        <div id="topic5" class="sts-data">-- <span class="sts-unit">Amp</span></div>
        <div id="kwh_sts3" class="sts-data">-- <span class="sts-unit">kWh</span></div>
        <div class="slow-down-legend" style="display: none;">GRUA EN SLOW DOWN</div>
        <div id="last_slow_sts3" class="last-slow-info"></div>
        <button class="btn-history" onclick="openHistory(3)">üìä Ver Historial KWH</button>
      </div>
    </div>
    <div id="topic6-cell" class="sts-box">
      <!-- Icono Ancla (STS4) -->
      <svg class="card-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="5" r="3"></circle><line x1="12" y1="22" x2="12" y2="8"></line><path d="M5 12H2a10 10 0 0 0 20 0h-3"></path></svg>
      <div class="sts-title">STS4</div>
      <div id="topic6Loader" class="loader" style="display: block; border-color: rgba(255,255,255,0.2); border-top-color: #fff;"></div>
      <div id="topic6Content" style="display: none;">
        <div id="topic6" class="sts-data">-- <span class="sts-unit">Amp</span></div>
        <div id="kwh_sts4" class="sts-data">-- <span class="sts-unit">kWh</span></div>
        <div class="slow-down-legend" style="display: none;">GRUA EN SLOW DOWN</div>
        <div id="last_slow_sts4" class="last-slow-info"></div>
        <button class="btn-history" onclick="openHistory(4)">üìä Ver Historial KWH</button>
      </div>
    </div>
    <div id="topic7-cell" class="sts-box">
      <!-- Icono Ancla (STS5) -->
      <svg class="card-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="5" r="3"></circle><line x1="12" y1="22" x2="12" y2="8"></line><path d="M5 12H2a10 10 0 0 0 20 0h-3"></path></svg>
      <div class="sts-title">STS5</div>
      <div id="topic7Loader" class="loader" style="display: block; border-color: rgba(255,255,255,0.2); border-top-color: #fff;"></div>
      <div id="topic7Content" style="display: none;">
        <div id="topic7" class="sts-data">-- <span class="sts-unit">Amp</span></div>
        <div id="kwh_sts5" class="sts-data">-- <span class="sts-unit">kWh</span></div>
        <div class="slow-down-legend" style="display: none;">GRUA EN SLOW DOWN</div>
        <div id="last_slow_sts5" class="last-slow-info"></div>
        <button class="btn-history" onclick="openHistory(5)">üìä Ver Historial KWH</button>
      </div>
    </div>
  </div>

  <!-- Modal para An√°lisis de Buque -->
  <div id="vesselModal" class="modal">
    <div class="modal-content" style="max-width: 1000px; padding: 0; border: none; border-radius: 12px;">
      <div class="modal-header-custom">
        <h2><span>üö¢</span> An√°lisis de Energ√≠a por Buque</h2>
        <span class="close-modal" onclick="closeVesselModal()" style="color: #fff; opacity: 0.8; float: none;">&times;</span>
      </div>
      
      <div class="modal-body-custom">
      <div class="input-panel">
      <div class="vessel-inputs">
        <div class="vessel-group">
          <label for="vesselName">Nombre del Buque</label>
          <input type="text" id="vesselName" placeholder="Ej: Casandra">
        </div>
        <div class="vessel-group">
          <label for="vesselStart">Inicio Faena</label>
          <input type="datetime-local" id="vesselStart">
        </div>
        <div class="vessel-group">
          <label for="vesselEnd">Fin Faena</label>
          <input type="datetime-local" id="vesselEnd">
        </div>
        <div class="vessel-group">
          <label>&nbsp;</label>
          <button class="btn-calc" onclick="runVesselAnalysis()">Calcular Consumo</button>
        </div>
      </div>
      </div>

      <div id="vesselLoader" class="loader"></div>
      <div id="vesselStatus" style="text-align: center; display: none; margin-bottom: 10px; color: #666;"></div>

      <div id="vesselResult" style="display: none; animation: fadeIn 0.5s;">
         <div id="vesselAlerts" class="analysis-alert" style="display: none;"></div>
         <div class="analysis-info">
            <div class="analysis-header">üìä Resumen de An√°lisis</div>
            <div class="analysis-dates">
               <div class="date-item">
                 <strong>Inicio:</strong>
                 <div id="resStart" class="date-value">--</div>
               </div>
               <div class="date-item">
                 <strong>Fin:</strong>
                 <div id="resEnd" class="date-value">--</div>
               </div>
            </div>
         </div>
         <div class="kpi-card">
            <div class="kpi-label" id="vesselTotalLabel">Total Faena</div>
            <div class="kpi-value" id="vesselTotalValue">--</div>
         </div>
         
         <div class="stats-grid">
            <div class="stat-card max-stat">
               <div class="stat-icon">üî•</div>
               <div class="stat-info">
                  <div class="stat-label">Mayor Consumo</div>
                  <div id="maxConsumer" class="stat-value">--</div>
                  <div id="maxConsumerValue" class="stat-sub">--</div>
               </div>
            </div>
            <div class="stat-card min-stat">
               <div class="stat-icon">üå±</div>
               <div class="stat-info">
                  <div class="stat-label">Menor Consumo</div>
                  <div id="minConsumer" class="stat-value">--</div>
                  <div id="minConsumerValue" class="stat-sub">--</div>
               </div>
            </div>
         </div>

         <div class="chart-container-modal" style="height: 400px; max-width: 100%; margin: 0 auto;">
           <canvas id="vesselChart"></canvas>
         </div>
      </div>
      </div>
    </div>
  </div>

  <div class="print-footer-page1">
    ¬© Desarrollado por Horacio Mella O. ‚Äì Ing. Electr√≥nico / Ing. El√©ctrico ‚Äì Depto. Mar√≠timo
  </div>
  </div>

  <!-- ------------ -->
  <div id="print-page-two">

  <!-- Alertas -->
  <div id="alertContainer">‚ö†Ô∏è Alerta: Valor alto detectado!</div>

  <div style="position: relative;">
    <div id="myChartLoader" class="loader" style="display: block; position: absolute; top: 45%; left: 50%; transform: translate(-50%, -50%); z-index: 10;"></div>
    <canvas id="myChart" width="900" height="450"></canvas> 
  </div>
  
  <h2 id="peakChartTitle" style="text-align: center; margin-top: 30px;">Gr√°fico Historial de Peaks</h2>
  <div style="position: relative;">
    <div id="peakChartLoader" class="loader" style="display: block; position: absolute; top: 45%; left: 50%; transform: translate(-50%, -50%); z-index: 10;"></div>
    <canvas id="peakChart" width="900" height="450"></canvas>
  </div>

  <!-- Tabla de Historial de Peaks -->
  <div style="text-align: center; margin-top: 40px; margin-bottom: 15px;">
    <h2 style="margin: 0 0 5px 0;">Historial de Sobreconsumo (Peaks)</h2>
    <div id="dataStatus" style="font-size: 0.9rem; font-weight: 600; opacity: 0.9;">
      <span id="historyIndicator" style="transition: color 0.3s;">üóÇÔ∏è Historial: Esperando...</span>
    </div>
    <div id="mainTableLoader" class="loader" style="display: block;"></div>
    <div id="historyDateRange" style="font-size: 0.8rem; opacity: 0.8; margin-top: 5px; display: none;">
      Muestreo desde <strong id="firstDate">--</strong> hasta <strong id="lastDate">--</strong>
    </div>
  </div>
  <div class="table-container">
    <table id="peakHistoryTable">
      <thead>
        <tr>
          <th scope="col">Fecha y Hora</th>
          <th scope="col">Valor del Peak (Amp)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="pagination">
    <button id="btnPrev" disabled>Anterior</button>
    <span id="pageInfo">P√°gina 1 de 1</span>
    <button id="btnNext" disabled>Siguiente</button>
  </div>

  <footer style="text-align: center; margin-top: 50px; margin-bottom: 20px; font-size: 0.9rem; opacity: 0.8;">
    ¬© Desarrollado por Horacio Mella O. ‚Äì Ing. Electr√≥nico / Ing. El√©ctrico ‚Äì Depto. Mar√≠timo
  </footer>
  </div>

  <!-- Modal para Historial KWH -->
  <div id="kwhModal" class="modal">
    <div class="modal-content">
      <div class="print-header-kwh" style="display: none;">
        <img src="logo puerto.png" alt="Logo">
        <h1>Sistema de Gesti√≥n Energ√©tica</h1>
      </div>
      <span class="close-modal" onclick="closeHistory()">&times;</span>
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h2 id="modalTitle" style="margin: 0; display: flex; align-items: center; gap: 10px;"><span>üìä</span> Historial KWH</h2>
        <button class="btn-export" onclick="printKwhReport()">üìÑ Generar Informe</button>
      </div>
      <div id="kwhReportTimestamp" class="print-only" style="margin-bottom: 10px;"></div>
      
      <div class="charts-wrapper">
        <div class="chart-container-modal"><canvas id="kwhShiftChart"></canvas></div>
        <div class="chart-container-modal"><canvas id="kwhWeeklyChart"></canvas></div>
        <div class="chart-container-modal" style="min-width: 100%; margin-top: 20px;"><canvas id="kwhMinuteChart"></canvas></div>
      </div>

      <div id="dailyTotalDisplay" class="daily-total-box">
        <div id="dailyTotalLabel" class="daily-total-label">Consumo Total D√≠a</div>
        <div id="dailyTotalValue" class="daily-total-value">-- kWh</div>
      </div>

      <div id="modalLoader" class="loader"></div>
      <div id="modalStatus" style="font-style: italic; color: #666; margin-bottom: 10px; text-align: center; display: none;">Cargando datos...</div>
      
      <!-- Tabla paginada para KWH -->
      <div class="table-container" style="max-height: 350px; overflow-y: auto;">
        <table id="kwhHistoryTable">
          <thead>
            <tr><th>Fecha y Hora</th><th>Turno</th><th>Energ√≠a</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="kwhPagination" style="display: flex; justify-content: center; align-items: center; margin-top: 15px; gap: 10px;">
        <button id="btnKwhPrev" disabled>Anterior</button>
        <span id="pageKwhInfo">P√°gina 1 de 1</span>
        <button id="btnKwhNext" disabled>Siguiente</button>
      </div>
      <div class="print-footer-kwh" style="display: none; text-align: center; margin-top: 30px; font-size: 0.8rem; border-top: 1px solid #ddd; padding-top: 10px;">
        ¬© Desarrollado por Horacio Mella O. ‚Äì Ing. Electr√≥nico / Ing. El√©ctrico ‚Äì Depto. Mar√≠timo
      </div>
    </div>
  </div>

<script>
  // Variables para modo oscuro persistente
  const bodyEl = document.body;
  const darkToggle = document.getElementById('darkModeToggle');
  const savedTheme = localStorage.getItem('theme');
  if(savedTheme === 'dark') {
    bodyEl.classList.add('dark-mode');
    darkToggle.textContent = 'Modo claro';
  }

  darkToggle.addEventListener('click', () => {
    bodyEl.classList.toggle('dark-mode');
    if(bodyEl.classList.contains('dark-mode')) {
      darkToggle.textContent = 'Modo claro';
      localStorage.setItem('theme', 'dark');
    } else {
      darkToggle.textContent = 'Modo oscuro';
      localStorage.setItem('theme', 'light');
    }
  });

  // Bot√≥n para generar informe (Imprimir / PDF)
  document.getElementById('reportBtn').addEventListener('click', () => {
    // Guardar configuraci√≥n actual
    const originalRows = rowsPerPage;
    // Cambiar a 50 filas para el reporte
    rowsPerPage = 50;
    
    // Agregar fecha y hora al reporte
    document.getElementById('reportTimestamp').textContent = `Generado el: ${new Date().toLocaleString()}`;

    renderTable();
    
    // Imprimir y luego restaurar
    setTimeout(() => {
      window.print();
      // Restaurar a 10 filas
      rowsPerPage = originalRows;
      renderTable();
    }, 500);
  });

  // MQTT y Chart.js con Zoom plugin
  const client = mqtt.connect('wss://mqtt-dashboard.com:8884/mqtt');
  const ctx = document.getElementById('myChart').getContext('2d');
  const connText = document.getElementById('connText');

  // Variables para Watchdog (Monitor de flujo de datos)
  let lastDataTime = Date.now();
  const DATA_TIMEOUT = 15000; // 15 segundos sin datos = alerta

  // Verificar flujo de datos peri√≥dicamente
  setInterval(() => {
    const statusEl = document.getElementById('connectionStatus');
    const textEl = document.getElementById('connText');
    
    // Solo si el cliente MQTT est√° conectado, verificamos si llegan datos
    if (client && client.connected) {
      if (Date.now() - lastDataTime > DATA_TIMEOUT) {
        if (statusEl.className !== 'status-warning') {
          statusEl.className = 'status-warning';
          textEl.textContent = 'Sin flujo de datos';
        }
      } else if (statusEl.className === 'status-warning') {
        statusEl.className = 'status-connected';
        textEl.textContent = 'Conectado';
      }
    }
  }, 2000);

  const data = {
    labels: [], 
    datasets: [{
      label: 'Medidor CGE (I Max)', 
      data: [],
      borderColor: '#0a72c1',
      backgroundColor: 'rgba(10, 114, 193, 0.3)',
      fill: true,
      tension: 0.3,
      pointRadius: 0,
      pointHoverRadius: 7,
      borderWidth: 3,
      hoverBorderWidth: 4
    }, {
      label: 'I_MAX_GRUAS', 
      data: [],
      borderColor: '#ffc72c',
      backgroundColor: 'rgba(255, 199, 44, 0.3)',
      fill: true,
      tension: 0.3,
      pointRadius: 0,
      pointHoverRadius: 7,
      borderWidth: 3,
      hoverBorderWidth: 4
    }
  ]
  };

  const config = {
    type: 'line',
    data,
    options: {
      animation: false,
      responsive: true,
      plugins: {
        legend: {
          labels: { color: getComputedStyle(document.body).getPropertyValue('--color-primary').trim() || '#0a3d66', font: { size: 16, weight: 'bold' } }
        },
        tooltip: {
          mode: 'index',
          intersect: false,
          backgroundColor: '#0a72c1',
          titleFont: { size: 16, weight: 'bold' },
          bodyFont: { size: 14 }
        },
      
      },
      scales: {
        x: {
          title: { display: true, text: 'Tiempo', color: getComputedStyle(document.body).getPropertyValue('--color-primary').trim() || '#0a3d66', font: { size: 18, weight: 'bold' } },
          ticks: { color: getComputedStyle(document.body).getPropertyValue('--color-primary').trim() || '#0a3d66', maxRotation: 45, minRotation: 30 },
          grid: { color: 'rgba(10, 61, 102, 0.15)' }
        },
        y: {
          title: { display: true, text: 'I Max', color: getComputedStyle(document.body).getPropertyValue('--color-primary').trim() || '#0a3d66', font: { size: 18, weight: 'bold' } },
          ticks: { color: getComputedStyle(document.body).getPropertyValue('--color-primary').trim() || '#0a3d66' },
          grid: { color: 'rgba(10, 61, 102, 0.15)' }
        }
      },
      interaction: {
        mode: 'nearest',
        axis: 'x',
        intersect: false
      }
    }
  };
  const myChart = new Chart(ctx, config);
  
  // Configuraci√≥n del Gr√°fico de Peaks
  const ctxPeak = document.getElementById('peakChart').getContext('2d');
  const peakChart = new Chart(ctxPeak, {
    type: 'line',
    data: {
      labels: [],
      datasets: [{
        label: 'Valor del Peak (Amp)',
        data: [],
        borderColor: '#dc3545',
        backgroundColor: 'rgba(220, 53, 69, 0.2)',
        fill: true,
        tension: 0.3,
        pointRadius: 4,
        pointHoverRadius: 6,
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          labels: { color: getComputedStyle(document.body).getPropertyValue('--color-primary').trim() || '#0a3d66', font: { size: 14, weight: 'bold' } }
        }
      },
      scales: {
        x: { display: false }, // Ocultar etiquetas X para limpieza visual
        y: { ticks: { color: getComputedStyle(document.body).getPropertyValue('--color-primary').trim() || '#0a3d66' } }
      }
    }
  });

  // Alertas
  const alertContainer = document.getElementById('alertContainer');
  const peakHistoryTableBody = document.querySelector('#peakHistoryTable tbody');
  let alertActive = false;
  
  // Variables para paginaci√≥n de historial
  let peakHistoryData = [];
  let renderTimeout;
  let lastRenderTime = 0;
  let rowsPerPage = 10;
  const maxPages = 150; 
  let currentPage = 1;

  const btnPrev = document.getElementById('btnPrev');
  const btnNext = document.getElementById('btnNext');
  const pageInfo = document.getElementById('pageInfo');

  btnPrev.addEventListener('click', () => {
    if (currentPage > 1) {
      currentPage--;
      renderTable();
    }
  });

  btnNext.addEventListener('click', () => {
    const totalPages = Math.ceil(peakHistoryData.length / rowsPerPage) || 1;
    if (currentPage < totalPages) {
      currentPage++;
      renderTable();
    }
  });

  function renderTable() {
    peakHistoryTableBody.innerHTML = '';
    const start = (currentPage - 1) * rowsPerPage;
    const end = start + rowsPerPage;
    const pageData = peakHistoryData.slice(start, end);

    pageData.forEach(item => {
      const row = peakHistoryTableBody.insertRow();
      const cellDate = row.insertCell(0);
      const cellValue = row.insertCell(1);
      cellDate.textContent = item.date;
      cellValue.textContent = item.value.toFixed(2);
    });

    const totalPages = Math.ceil(peakHistoryData.length / rowsPerPage) || 1;
    pageInfo.textContent = `P√°gina ${currentPage} de ${totalPages}`;
    btnPrev.disabled = currentPage === 1;
    btnNext.disabled = currentPage === totalPages;
  }

  function updateLastPeakWidget() {
    const loader = document.getElementById('lastPeakLoader');
    const content = document.getElementById('lastPeakContent');
    
    if (peakHistoryData.length > 0) {
      const latest = peakHistoryData[0]; // El primero es el m√°s reciente
      document.getElementById('lastPeakValue').innerHTML = `${latest.value.toFixed(2)} <span class="sts-unit">Amp</span>`;
      document.getElementById('lastPeakDate').textContent = latest.date;
    }
    if(loader) loader.style.display = 'none';
    if(content) content.style.display = 'block';
  }

  function updatePeakChart() {
    // Invertimos los datos para que el gr√°fico muestre de m√°s antiguo a m√°s nuevo
    const chartData = [...peakHistoryData].reverse();
    peakChart.data.labels = chartData.map(d => d.date);
    peakChart.data.datasets[0].data = chartData.map(d => d.value);
    peakChart.update();
  }

  function updateHistoryDateRange() {
    const dateRangeEl = document.getElementById('historyDateRange');
    if (peakHistoryData.length > 1) {
      // peakHistoryData est√° ordenado con el m√°s nuevo en el √≠ndice 0 (por unshift)
      const newestDate = peakHistoryData[0].date;
      const oldestDate = peakHistoryData[peakHistoryData.length - 1].date;
      
      document.getElementById('firstDate').textContent = oldestDate;
      document.getElementById('lastDate').textContent = newestDate;
      dateRangeEl.style.display = 'block';
    } else {
      dateRangeEl.style.display = 'none';
    }
  }

  function addPeakToHistory(value, datetime) {
    // A√±adir al array de datos
    peakHistoryData.unshift({ date: datetime, value: value });
    
    // Limitar a 150 p√°ginas (10 * 150 = 1500 registros)
    if (peakHistoryData.length > (rowsPerPage * maxPages)) {
      peakHistoryData.pop();
    }

    // Si estamos en la primera p√°gina, renderizamos para ver el nuevo dato
    if (currentPage === 1) {
      renderTable();
    } else {
      // Actualizar solo info de paginaci√≥n si estamos en otra p√°gina
      const totalPages = Math.ceil(peakHistoryData.length / rowsPerPage) || 1;
      pageInfo.textContent = `P√°gina ${currentPage} de ${totalPages}`;
      btnNext.disabled = currentPage === totalPages;
    }

    // Actualizar el widget del √∫ltimo peak
    updateLastPeakWidget();
    updatePeakChart();
    updateHistoryDateRange();
  }

  function showVisualAlert(value) {
    alertContainer.style.display = 'block';
    alertContainer.textContent = `‚ö†Ô∏è Alerta: Valor alto detectado! Valor actual: ${value.toFixed(2)}`;

    setTimeout(() => {
      if(alertActive) return;
      alertContainer.style.display = 'none';
    }, 5000);
  }

  // --- L√≥gica del Historial KWH (Modal) ---
  let currentStsHistoryId = null;
  let kwhChartInstance = null; // Variable global para el gr√°fico del modal
  let kwhWeeklyChartInstance = null; // Variable global para el gr√°fico semanal
  let kwhMinuteChartInstance = null; // Variable global para el gr√°fico por minuto
  
  // Variables para paginaci√≥n KWH
  let kwhData = [];
  let currentKwhPage = 1;

    let kwhRowsPerPage = 3; // Mostrar 3 turnos por p√°gina

  // Listeners para paginaci√≥n KWH
  document.getElementById('btnKwhPrev').addEventListener('click', () => {
    if (currentKwhPage > 1) {
      currentKwhPage--;
      renderKwhTable();
    }
  });
  document.getElementById('btnKwhNext').addEventListener('click', () => {
    const totalPages = Math.ceil(kwhData.length / kwhRowsPerPage) || 1;
    if (currentKwhPage < totalPages) {
      currentKwhPage++;
      renderKwhTable();
    }
  });

  function renderKwhTable() {
    const tbody = document.querySelector('#kwhHistoryTable tbody');
    tbody.innerHTML = '';
    const start = (currentKwhPage - 1) * kwhRowsPerPage;
    const end = start + kwhRowsPerPage;
    const pageData = kwhData.slice(start, end);

    pageData.forEach(item => {
      const row = tbody.insertRow();
      const lecturaHtml = item.hora ? `<span style="font-size:0.85em; color:#666; display:block;">Lectura: ${item.hora}</span>` : '<span style="font-size:0.85em; color:#aaa; display:block; font-style:italic;">Sin datos</span>';
      row.innerHTML = `<td>${item.fechaTurno} ${lecturaHtml}</td><td>${item.turno || '-'}</td><td><strong>${item.energiaStr} ${item.isPlaceholder ? '' : 'kWh'}</strong></td>`;
    });
    
    // Actualizar gr√°fico con los datos de la p√°gina actual
    updateKwhChart(pageData);
    
    // Calcular y mostrar total del d√≠a (suma de los 3 turnos mostrados)
    const dailyTotal = pageData.reduce((sum, item) => sum + (item.consumo || 0), 0);
    document.getElementById('dailyTotalLabel').textContent = `Consumo Total D√≠a (${pageData[0]?.fechaTurno || '--'})`;
    document.getElementById('dailyTotalValue').textContent = `${dailyTotal.toFixed(2)} kWh`;

    const totalPages = Math.ceil(kwhData.length / kwhRowsPerPage) || 1;
    document.getElementById('pageKwhInfo').textContent = `P√°gina ${currentKwhPage} de ${totalPages}`;
    document.getElementById('btnKwhPrev').disabled = currentKwhPage === 1;
    document.getElementById('btnKwhNext').disabled = currentKwhPage >= totalPages;
  }

  function updateKwhChart(items) {
    if (kwhChartInstance) kwhChartInstance.destroy();
    
    // Ordenar cronol√≥gicamente (antiguo a nuevo) para el gr√°fico
    const chartData = [...items].sort((a, b) => a.shiftSortKey - b.shiftSortKey);
    
    const labels = chartData.map(i => i.turno || i.fecha);
    const data = chartData.map(i => i.consumo || 0);
    
    // Colores din√°micos seg√∫n el turno
    const bgColors = chartData.map(i => {
      const t = (i.turno || '').toLowerCase();
      if(t.includes('turno 1')) return 'rgba(255, 199, 44, 0.7)'; // Amarillo
      if(t.includes('turno 2')) return 'rgba(10, 114, 193, 0.7)'; // Azul
      if(t.includes('turno 3')) return 'rgba(40, 167, 69, 0.7)';  // Verde
      return 'rgba(100, 100, 100, 0.7)';
    });
    const borderColors = chartData.map(i => {
      const t = (i.turno || '').toLowerCase();
      if(t.includes('turno 1')) return '#ffc72c';
      if(t.includes('turno 2')) return '#0a72c1';
      if(t.includes('turno 3')) return '#28a745';
      return '#666';
    });

    const ctxModal = document.getElementById('kwhShiftChart').getContext('2d');
    kwhChartInstance = new Chart(ctxModal, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Consumo del Turno (kWh)',
          data: data,
          backgroundColor: bgColors,
          borderColor: borderColors,
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          title: { display: true, text: 'Consumo por Turno (Visualizado)' }
        },
        scales: { y: { beginAtZero: true, title: { display: true, text: 'kWh' } } }
      }
    });
  }

  function updateMinuteChart(items) {
    if (kwhMinuteChartInstance) kwhMinuteChartInstance.destroy();

    // Ordenar por timestamp para asegurar la secuencia temporal
    const sortedItems = [...items].sort((a, b) => a.timestamp - b.timestamp);
    
    const labels = [];
    const data = [];
    let totalConsumo = 0;

    // Calcular consumo (delta) entre registros consecutivos
    for (let i = 1; i < sortedItems.length; i++) {
      const prev = sortedItems[i-1];
      const curr = sortedItems[i];
      let diff = curr.energiaVal - prev.energiaVal;
      
      // Validaci√≥n simple: si es negativo (reinicio de medidor), asumimos 0
      if (diff < 0) diff = 0;
      
      labels.push(`${curr.fecha} ${curr.hora}`);
      data.push(diff);
      totalConsumo += diff;
    }

    const ctxMinute = document.getElementById('kwhMinuteChart').getContext('2d');
    kwhMinuteChartInstance = new Chart(ctxMinute, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'Consumo por Minuto (kWh)',
          data: data,
          borderColor: '#17a2b8', // Color Cyan/Teal
          backgroundColor: 'rgba(23, 162, 184, 0.1)',
          borderWidth: 1,
          pointRadius: 0, // Puntos ocultos por defecto para limpieza visual
          pointHoverRadius: 4,
          fill: true,
          tension: 0.2
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: true },
          title: { display: true, text: 'Consumo Detallado (Minuto a Minuto)' },
          tooltip: {
            mode: 'index',
            intersect: false,
            callbacks: { label: (c) => `Consumo: ${c.parsed.y.toFixed(2)} kWh` }
          }
        },
        scales: {
          x: { ticks: { maxTicksLimit: 12 } },
          y: { beginAtZero: true, title: { display: true, text: 'kWh' } }
        },
        interaction: { mode: 'nearest', axis: 'x', intersect: false }
      }
    });
  }

  function updateWeeklyChart(weeklyData) {
    if (kwhWeeklyChartInstance) kwhWeeklyChartInstance.destroy();

    const labels = weeklyData.map(d => `Semana ${d.label}`);
    const data = weeklyData.map(d => d.total);

    const ctxWeekly = document.getElementById('kwhWeeklyChart').getContext('2d');
    kwhWeeklyChartInstance = new Chart(ctxWeekly, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Consumo Semanal Total (kWh)',
          data: data,
          backgroundColor: 'rgba(54, 162, 235, 0.6)',
          borderColor: '#36a2eb',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          title: { display: true, text: 'Consumo Total por Semana' }
        },
        scales: { 
          y: { beginAtZero: true, title: { display: true, text: 'kWh' } },
          x: { title: { display: true, text: 'Inicio de Semana' } }
        }
      }
    });
  }

  // --- L√≥gica de An√°lisis por Buque ---
  let vesselChartInstance = null;
  let vesselAnalysisActive = false;
  let vesselDataStore = {}; // Almacena datos temporales de las 5 gr√∫as

  function openVesselModal() {
    document.getElementById('vesselModal').style.display = 'block';
    // Inicializar fechas si est√°n vac√≠as
    const vStart = document.getElementById('vesselStart');
    const vEnd = document.getElementById('vesselEnd');
    if(!vStart.value || !vEnd.value) {
        const now = new Date();
        const yesterday = new Date(now); yesterday.setDate(now.getDate() - 1);
        const toLocalIso = (d) => {
          const offset = d.getTimezoneOffset() * 60000;
          return new Date(d.getTime() - offset).toISOString().slice(0, 16);
        };
        if(!vStart.value) vStart.value = toLocalIso(yesterday);
        if(!vEnd.value) vEnd.value = toLocalIso(now);
    }
  }

  function closeVesselModal() {
    document.getElementById('vesselModal').style.display = 'none';
    vesselAnalysisActive = false;
  }

  function runVesselAnalysis() {
    const name = document.getElementById('vesselName').value;
    const startVal = document.getElementById('vesselStart').value;
    const endVal = document.getElementById('vesselEnd').value;

    if (!startVal || !endVal) {
      alert("Por favor seleccione fecha de inicio y fin.");
      return;
    }

    const startTime = new Date(startVal).getTime();
    const endTime = new Date(endVal).getTime();

    if (endTime <= startTime) {
      alert("La fecha de fin debe ser mayor a la de inicio.");
      return;
    }

    // UI Update
    document.getElementById('vesselResult').style.display = 'none';
    document.getElementById('vesselLoader').style.display = 'block';
    document.getElementById('vesselStatus').style.display = 'block';
    document.getElementById('vesselStatus').textContent = "Solicitando datos a las 5 gr√∫as...";

    // Resetear estado
    vesselAnalysisActive = true;
    vesselDataStore = { 1: null, 2: null, 3: null, 4: null, 5: null };

    // Solicitar datos a todas las gr√∫as
    for(let i=1; i<=5; i++) {
      client.subscribe(`KWH_STS${i}_archivo_KWH`);
      client.publish(`consultasts${i}_archivo_KWH`, 'req');
    }

    // Timeout de seguridad (5 segundos)
    setTimeout(() => {
      if(vesselAnalysisActive) {
        processVesselResults(startTime, endTime, name);
      }
    }, 5000);
  }

  function processVesselResults(startTime, endTime, vesselName) {
    vesselAnalysisActive = false;
    document.getElementById('vesselLoader').style.display = 'none';
    document.getElementById('vesselStatus').style.display = 'none';
    document.getElementById('vesselResult').style.display = 'block';

    const alertBox = document.getElementById('vesselAlerts');
    alertBox.style.display = 'none';
    alertBox.innerHTML = '';

    // Mostrar fechas formateadas
    document.getElementById('resStart').textContent = new Date(startTime).toLocaleString();
    document.getElementById('resEnd').textContent = new Date(endTime).toLocaleString();

    const results = [];
    const warnings = [];
    let totalConsumption = 0;

    for(let i=1; i<=5; i++) {
      const craneData = vesselDataStore[i] || [];
      let consumption = 0;

      if (craneData.length > 0) {
        // Ordenar por tiempo
        craneData.sort((a, b) => a.timestamp - b.timestamp);

        const getClosest = (target) => {
          return craneData.reduce((prev, curr) => 
            Math.abs(curr.timestamp - target) < Math.abs(prev.timestamp - target) ? curr : prev
          );
        };

        const startReading = getClosest(startTime);
        const endReading = getClosest(endTime);
        
        if (startReading && endReading) {
           // Verificar si los datos est√°n muy alejados de la fecha solicitada (ej. > 4 horas)
           const tolerance = 4 * 60 * 60 * 1000; // 4 horas
           const diffStart = Math.abs(startReading.timestamp - startTime);
           const diffEnd = Math.abs(endReading.timestamp - endTime);

           if (diffStart > tolerance || diffEnd > tolerance) {
             warnings.push(`STS ${i}: Datos incompletos o fuera de rango temporal (Posible falla de registro).`);
           }

           consumption = endReading.energiaVal - startReading.energiaVal;
           if (consumption < 0) consumption = 0; 
        }
      } else {
        warnings.push(`STS ${i}: No se encontraron datos registrados para este periodo.`);
      }
      
      results.push({ crane: `STS ${i}`, value: consumption });
      totalConsumption += consumption;
    }

    // Mostrar alertas si existen
    if (warnings.length > 0) {
      alertBox.style.display = 'block';
      alertBox.innerHTML = warnings.map(w => `<div>‚ö†Ô∏è ${w}</div>`).join('');
    }

    // Mostrar Total
    document.getElementById('vesselTotalLabel').textContent = `Total Faena ${vesselName ? '"'+vesselName+'"' : ''}`;
    document.getElementById('vesselTotalValue').innerHTML = `${totalConsumption.toFixed(2)} <span style="font-size: 1.5rem; font-weight: 400;">kWh CONSUMIDOS</span>`;

    // Calcular Mayor y Menor Consumo
    let maxObj = results[0];
    let minObj = results[0];
    results.forEach(r => {
        if (r.value > maxObj.value) maxObj = r;
        if (r.value < minObj.value) minObj = r;
    });
    document.getElementById('maxConsumer').textContent = maxObj.crane;
    document.getElementById('maxConsumerValue').textContent = `${maxObj.value.toFixed(2)} kWh`;
    document.getElementById('minConsumer').textContent = minObj.crane;
    document.getElementById('minConsumerValue').textContent = `${minObj.value.toFixed(2)} kWh`;

    // Renderizar Gr√°fico
    if (vesselChartInstance) vesselChartInstance.destroy();
    const ctx = document.getElementById('vesselChart').getContext('2d');
    vesselChartInstance = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: results.map(r => r.crane),
        datasets: [{
          label: 'Consumo (kWh)',
          data: results.map(r => r.value),
          backgroundColor: ['#0a72c1', '#ffc72c', '#dc3545', '#28a745', '#6f42c1'],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          title: { display: true, text: 'Consumo de Energ√≠a por Gr√∫a' }
        }
      }
    });
  }

  function printKwhReport() {
    const originalRows = kwhRowsPerPage;
    const originalPage = currentKwhPage;
    
    // Mostrar todo para el reporte
    // kwhRowsPerPage = kwhData.length || 1; // Comentado para mantener solo los 3 turnos en el reporte
    currentKwhPage = 1;
    
    // Timestamp
    const tsEl = document.getElementById('kwhReportTimestamp');
    if(tsEl) tsEl.textContent = `Generado el: ${new Date().toLocaleString()}`;
    
    document.body.classList.add('printing-modal');
    renderKwhTable();
    
    setTimeout(() => {
      window.print();
      document.body.classList.remove('printing-modal');
      kwhRowsPerPage = originalRows;
      currentKwhPage = originalPage;
      renderKwhTable();
    }, 500);
  }

  function exportKwhToCsv() {
    if (!kwhData || kwhData.length === 0) {
      alert("No hay datos disponibles para exportar.");
      return;
    }
    
    let csvContent = "data:text/csv;charset=utf-8,";
    csvContent += "Fecha Turno,Hora Lectura,Turno,Energia (kWh),Consumo Turno (kWh)\n";
    
    kwhData.forEach(row => {
      if (!row.isPlaceholder) {
         csvContent += `${row.fechaTurno},${row.hora},${row.turno},${row.energiaVal},${row.consumo}\n`;
      }
    });
    
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", `Reporte_KWH_STS${currentStsHistoryId}_${new Date().toISOString().slice(0,10)}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }

  function openHistory(stsId) {
    currentStsHistoryId = stsId;
    const modal = document.getElementById('kwhModal');
    const title = document.getElementById('modalTitle');
    const status = document.getElementById('modalStatus');
    const loader = document.getElementById('modalLoader');
    
    modal.style.display = "block";
    title.textContent = `Historial KWH - STS ${stsId}`;
    
    // Resetear datos y tabla
    kwhData = [];
    currentKwhPage = 1;
    renderKwhTable();
    
    status.style.display = "none";
    loader.style.display = "block"; // Mostrar spinner

    // Suscribirse al t√≥pico de respuesta espec√≠fico
    const responseTopic = `KWH_STS${stsId}_archivo_KWH`;
    const requestTopic = `consultasts${stsId}_archivo_KWH`;
    
    client.subscribe(responseTopic, (err) => {
      if(!err) {
        console.log(`Suscrito a ${responseTopic} para historial.`);
        // Publicar solicitud
        client.publish(requestTopic, 'req');
      }
    });
  }

  function closeHistory() {
    const modal = document.getElementById('kwhModal');
    modal.style.display = "none";
    
    if(currentStsHistoryId !== null) {
      const responseTopic = `KWH_STS${currentStsHistoryId}_archivo_KWH`;
      client.unsubscribe(responseTopic);
      console.log(`Desuscrito de ${responseTopic}`);
      currentStsHistoryId = null;
    }
    // Destruir gr√°fico al cerrar para liberar memoria
    if (kwhChartInstance) {
      kwhChartInstance.destroy();
      kwhChartInstance = null;
    }
    if (kwhWeeklyChartInstance) {
      kwhWeeklyChartInstance.destroy();
      kwhWeeklyChartInstance = null;
    }
    if (kwhMinuteChartInstance) {
      kwhMinuteChartInstance.destroy();
      kwhMinuteChartInstance = null;
    }
  }

  // Cerrar modal si se hace clic fuera
  window.onclick = function(event) {
    const modal = document.getElementById('kwhModal');
    if (event.target == modal) {
      closeHistory();
    }
    const vModal = document.getElementById('vesselModal');
    if (event.target == vModal) {
      closeVesselModal();
    }
  }

   // Suscripci√≥n al topic
  client.on('connect', () => {
    console.log('Conectado al broker MQTT');
    connText.textContent = 'Conectado';
    document.getElementById('connectionStatus').className = 'status-connected';
    lastDataTime = Date.now(); // Reiniciar contador al conectar
    client.subscribe('MEDIDOR_CGE');
    client.subscribe('I_MAX_GRUAS');  // Suscripci√≥n al topic I_MAX_GRUAS
    client.subscribe('I_STS1');
    client.subscribe('I_STS2');
    client.subscribe('I_STS3');
    client.subscribe('I_STS4');
    client.subscribe('I_STS5');
    client.subscribe('SLOWSTS1');
    client.subscribe('SLOWSTS2');
    client.subscribe('SLOWSTS3');
    client.subscribe('SLOWSTS4');
    client.subscribe('SLOWSTS5');
    client.subscribe('Viento_STS1');
    client.subscribe('REGISTRO_PEAK');
    client.subscribe('RESPUESTA_SLOWSTS'); // Suscripci√≥n para recibir info de √∫ltimo slow down
    client.subscribe('HISTORIAL_PEAKS'); // Suscripci√≥n para recibir el historial
    client.subscribe(['KWH_STS1', 'KWH_STS2', 'KWH_STS3', 'KWH_STS4', 'KWH_STS5'], (err) => {
      if (!err) {
        console.log("Suscrito a t√≥picos KWH. Iniciando consultas peri√≥dicas.");
        // Publicar peri√≥dicamente para solicitar datos de KWH
        setInterval(() => {
          console.log("Publicando solicitud de KWH...");
          client.publish('consultasts1', 'req');
          client.publish('consultasts2', 'req');
          client.publish('consultasts3', 'req');
          client.publish('consultasts4', 'req');
          client.publish('consultasts5', 'req');
        }, 5000); // Consulta cada 5 segundos

        // Solicitar el historial de peaks al conectar (para cargar datos del turno)
        client.publish('CONSULTA_PEAKS', 'req');
        document.getElementById('historyIndicator').textContent = "üóÇÔ∏è Historial: Solicitando...";
        document.getElementById('historyIndicator').style.color = "#fd7e14"; // Naranja
        document.getElementById('mainTableLoader').style.display = 'block';

        // Solicitar informaci√≥n del √∫ltimo Slow Down
        client.publish('CONSULTA_SLOWSTS', 'req');
      }
    });
  });
   //
   
  client.on('reconnect', () => {
    connText.textContent = 'Reconectando...';
    document.getElementById('connectionStatus').className = 'status-reconnecting';
  });

  client.on('close', () => {
    connText.textContent = 'Desconectado';
    document.getElementById('connectionStatus').className = 'status-disconnected';
  });

  client.on('error', (err) => {
    console.error('Error MQTT:', err);
    connText.textContent = 'Error de conexi√≥n';
    document.getElementById('connectionStatus').className = 'status-disconnected';
  });

  client.on('message', (topic, message) => {
    // Actualizar watchdog con cada mensaje recibido (indica que Node-RED est√° vivo)
    lastDataTime = Date.now();

    if (topic === 'MEDIDOR_CGE') {
      const value = parseFloat(message.toString());
      if (!isNaN(value)) {
        const now = new Date();
        const timeLabel = now.toLocaleTimeString();
        const fullDate = now.toLocaleString();

        // Actualizamos el recuadro de MEDIDOR_CGE (topic1)
        document.getElementById('topic1').innerHTML = `${value.toFixed(2)} <span class="sts-unit">Amp</span>`;
        document.getElementById('topic1Loader').style.display = 'none';
        document.getElementById('topic1Content').style.display = 'block';

        // Alerta ejemplo: valor > 120
        if(value > 120) {
          // Solo registrar si NO estaba activa la alerta previamente (Flanco de subida)
          if (!alertActive) {
            alertActive = true;
            showVisualAlert(value); 
            addPeakToHistory(value, fullDate); // Agregamos inmediatamente a la tabla local
            // Enviar datos por MQTT para registro en CSV/Base de datos
            const payload = JSON.stringify({ date: fullDate, value: value });
            client.publish('REGISTRO_PEAK', payload);
          }
        } else {
          alertActive = false;
          alertContainer.style.display = 'none';
        }

        // Actualizar el gr√°fico
        data.labels.push(timeLabel);
        data.datasets[0].data.push(value);
        data.datasets[1].data.push(NaN); // Valor nulo para la otra l√≠nea

        // Recortar los datos si superan los 20 puntos
        while (data.labels.length > 20) {
          data.labels.shift();
          data.datasets[0].data.shift();
          data.datasets[1].data.shift();
        }

        document.getElementById('myChartLoader').style.display = 'none';
        myChart.update(); // Actualizar el gr√°fico directamente
      }
    }
    if (topic === 'I_MAX_GRUAS') {  // Mensajes de I_MAX_GRUAS
      const value = parseFloat(message.toString());
      if (!isNaN(value)) {
        const now = new Date();
        const timeLabel = now.toLocaleTimeString();
        const fullDate = now.toLocaleString();

        // Actualizamos el recuadro de I_MAX_GRUAS (topic2)
         document.getElementById('topic2').innerHTML = `${value.toFixed(2)} <span class="sts-unit">Amp</span>`;
         document.getElementById('topic2Loader').style.display = 'none';
         document.getElementById('topic2Content').style.display = 'block';

        // En lugar de crear un nuevo punto, actualizamos el √∫ltimo punto del gr√°fico
        const lastDataIndex = data.datasets[1].data.length - 1;
        if (lastDataIndex >= 0) {
          // Si ya hay un punto de MEDIDOR_CGE, reemplazamos el NaN con el valor de I_MAX_GRUAS
          data.datasets[1].data[lastDataIndex] = value;
        }

        document.getElementById('myChartLoader').style.display = 'none';
        myChart.update(); // Actualizar el gr√°fico directamente
      }
    }
        // Manejo de los nuevos topics: I_STS1, I_STS2, I_STS3, I_STS4, I_STS5
    const stsTopics = ['I_STS1', 'I_STS2', 'I_STS3', 'I_STS4', 'I_STS5'];
    const topicIndex = stsTopics.indexOf(topic);

    if (topicIndex >= 0) {  // Si es uno de los nuevos topics
      const value = parseFloat(message.toString());
      if (!isNaN(value)) {
        const now = new Date();
        const timeLabel = now.toLocaleTimeString();

        // Actualizar el recuadro correspondiente para I_STS1, I_STS2, I_STS3, I_STS4, I_STS5
        document.getElementById(`topic${topicIndex + 3}`).innerHTML = `${value.toFixed(2)} <span class="sts-unit">Amp</span>`;
        document.getElementById(`topic${topicIndex + 3}Loader`).style.display = 'none';
        document.getElementById(`topic${topicIndex + 3}Content`).style.display = 'block';
      }
    }

    // Manejo de los topics de SLOW DOWN
    const slowTopics = ['SLOWSTS1', 'SLOWSTS2', 'SLOWSTS3', 'SLOWSTS4', 'SLOWSTS5'];
    const slowTopicIndex = slowTopics.indexOf(topic);

    if (slowTopicIndex >= 0) {
      const isSlow = message.toString().toLowerCase() === 'true';
      const cell = document.getElementById(`topic${slowTopicIndex + 3}-cell`);
      const legend = cell.querySelector('.slow-down-legend');

      if (isSlow) {
        cell.style.backgroundColor = '#ff4c4c'; // Rojo
        legend.style.display = 'block';
        // Solicitar actualizaci√≥n inmediata del √∫ltimo slow down
        client.publish('CONSULTA_SLOWSTS', 'req');
      } else {
        cell.style.backgroundColor = '#76acdf'; // Azul por defecto
        legend.style.display = 'none';
      }
    }

    // Manejo de RESPUESTA_SLOWSTS (√öltimo Slow Down)
    if (topic === 'RESPUESTA_SLOWSTS') {
      try {
        // Formato esperado: {"ultimo_slowdown":"SLOWSTS4","fecha_hora":"01-01-2026, 21:13:41","status_plc":"OK"}
        const responseData = JSON.parse(message.toString());
        
        const craneMap = {
          'SLOWSTS1': 'last_slow_sts1',
          'SLOWSTS2': 'last_slow_sts2',
          'SLOWSTS3': 'last_slow_sts3',
          'SLOWSTS4': 'last_slow_sts4',
          'SLOWSTS5': 'last_slow_sts5'
        };

        const elementId = craneMap[responseData.ultimo_slowdown];
        if (elementId && responseData.fecha_hora) {
          const el = document.getElementById(elementId);
          el.innerHTML = `√öltimo Slow:<br>${responseData.fecha_hora}`;
          el.style.display = 'block';
        }
      } catch (e) { console.error("Error procesando respuesta slow sts:", e); }
    }

    // Manejo de respuestas de Historial KWH (Din√°mico)
    // Patr√≥n: KWH_STS{N}_archivo_KWH
    if (topic.startsWith('KWH_STS') && topic.endsWith('_archivo_KWH')) {
      const status = document.getElementById('modalStatus');
      const loader = document.getElementById('modalLoader');
      const rawData = message.toString();
      
      // Extraemos el ID de la gr√∫a del t√≥pico de forma segura
      const match = topic.match(/STS(\d+)/);

      // Verificamos que el t√≥pico tenga un ID num√©rico y que el modal est√© abierto para esa gr√∫a
      if (match && match[1]) {
        const stsIdFromTopic = parseInt(match[1], 10);

        // --- PARSEO DE DATOS (Com√∫n para Historial y An√°lisis Buque) ---
        const lines = rawData.split('\n').filter(line => line.trim() !== '');
        const parsedItems = [];
        
        lines.forEach(line => {
          const parts = line.split(',');
          if (parts.length >= 3) {
            let ts = 0;
            try {
              const dStr = parts[0].trim();
              const tStr = parts[1].trim();
              const dParts = dStr.split(/[-/]/);
              if (dParts.length === 3) {
                let cleanTime = tStr.toLowerCase().replace(/\./g, '').replace(/\s/g, '');
                let matchTime = cleanTime.match(/^(\d{1,2}):(\d{1,2}):?(\d{1,2})?/);
                if (matchTime) {
                  let h = parseInt(matchTime[1], 10);
                  if (cleanTime.includes('pm') && h !== 12) h += 12;
                  if (cleanTime.includes('am') && h === 12) h = 0;
                  ts = new Date(dParts[2], dParts[1]-1, dParts[0], h, parseInt(matchTime[2]), matchTime[3]?parseInt(matchTime[3]):0).getTime();
                }
              }
            } catch(e){}

            parsedItems.push({
              fecha: parts[0].trim(),
              hora: parts[1].trim(),
              energiaVal: parseFloat(parts[2].trim()),
              energiaStr: parts[2].trim(),
              turno: parts.length > 3 ? parts[3].trim() : '',
              timestamp: ts
            });
          }
        });

        // --- CASO 1: AN√ÅLISIS DE BUQUE ACTIVO ---
        if (vesselAnalysisActive) {
          vesselDataStore[stsIdFromTopic] = parsedItems;
          // Verificar si ya tenemos datos de las 5 gr√∫as
          const allReceived = Object.values(vesselDataStore).every(val => val !== null);
          if (allReceived) {
             // Si tenemos todo, procesamos inmediatamente (sin esperar timeout)
             const startVal = document.getElementById('vesselStart').value;
             const endVal = document.getElementById('vesselEnd').value;
             const name = document.getElementById('vesselName').value;
             processVesselResults(new Date(startVal).getTime(), new Date(endVal).getTime(), name);
          }
        }

        // Solo procesamos si el modal de la gr√∫a correcta est√° abierto
        if (currentStsHistoryId === stsIdFromTopic) {
          try {
            if (parsedItems.length > 0) {
              loader.style.display = "none"; // Ocultar spinner
              status.style.display = "none"; 
              
              // Actualizar gr√°fico de consumo por minuto (datos crudos)
              updateMinuteChart(parsedItems);
              
              // 2. Agrupar por (Fecha + Turno) y quedarse con el menor valor de energ√≠a
              const minByShift = {};
              parsedItems.forEach(item => {
                if (isNaN(item.energiaVal)) return;
                
                // Normalizar fecha base para asegurar formato consistente (DD-MM-YYYY)
                let d;
                const dateParts = item.fecha.split(/[-/]/);
                if (dateParts.length === 3) {
                  d = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
                } else {
                  return; // Fecha inv√°lida, saltar
                }

                // L√≥gica especial para Turno 3 (23:00 - 08:00)
                if (item.turno && item.turno.toLowerCase().includes("turno 3")) {
                  // Normalizar hora: eliminar puntos y espacios para chequear am/pm
                  const cleanTime = item.hora.toLowerCase().replace(/\./g, '').replace(/\s/g, '');
                  
                  const match = cleanTime.match(/^(\d{1,2}):/);
                  let hour = match ? parseInt(match[1], 10) : -1;

                  // Ajuste 12h -> 24h
                  if (cleanTime.includes('pm') && hour !== 12) hour += 12;
                  else if (cleanTime.includes('am') && hour === 12) hour = 0;

                  // Si es madrugada (00:00 a 07:59), restamos un d√≠a
                  if (hour >= 0 && hour < 8) {
                    d.setDate(d.getDate() - 1);
                  }
                }

                // Guardar Fecha del Turno (Operativa)
                const shiftDay = String(d.getDate()).padStart(2, '0');
                const shiftMonth = String(d.getMonth() + 1).padStart(2, '0');
                const shiftYear = d.getFullYear();
                item.fechaTurno = `${shiftDay}-${shiftMonth}-${shiftYear}`;

                // Calcular clave de ordenamiento basada en Fecha Turno + Orden de Turno
                // Esto asegura que T3 (noche) quede ordenado correctamente respecto a T1 y T2
                let shiftOrder = 0;
                const tLower = item.turno ? item.turno.toLowerCase() : '';
                if (tLower.includes('turno 1')) shiftOrder = 1;
                else if (tLower.includes('turno 2')) shiftOrder = 2;
                else if (tLower.includes('turno 3')) shiftOrder = 3;
                
                // Timestamp base del d√≠a del turno + offset por turno
                item.shiftSortKey = d.getTime() + (shiftOrder * 3600000);

                // Construir clave √∫nica normalizada para el filtro
                const turnoKey = item.turno ? item.turno.toLowerCase().replace(/\s/g, '') : 'sin_turno';
                const key = `${item.fechaTurno}_${turnoKey}`;
                
                // Si es el primero de este turno o encontramos una energ√≠a menor, lo guardamos
                if (!minByShift[key] || item.energiaVal < minByShift[key].energiaVal) {
                  minByShift[key] = item;
                }
              });

              // 3. Filtrar la lista original para mostrar solo los registros seleccionados (m√≠nimos)
              const winners = new Set(Object.values(minByShift));
              const itemsToShow = parsedItems.filter(item => winners.has(item));
              
              // Ordenar por clave de turno descendente (M√°s reciente arriba)
              itemsToShow.sort((a, b) => b.shiftSortKey - a.shiftSortKey);

              // Calcular consumo por turno (Diferencia con el siguiente registro cronol√≥gico)
              const sortedAsc = [...itemsToShow].sort((a, b) => a.shiftSortKey - b.shiftSortKey);
              for (let i = 0; i < sortedAsc.length - 1; i++) {
                const diff = sortedAsc[i+1].energiaVal - sortedAsc[i].energiaVal;
                sortedAsc[i].consumo = diff >= 0 ? diff : 0;
              }
              // El √∫ltimo registro (m√°s reciente) no tiene "siguiente" para cerrar el turno a√∫n
              if(sortedAsc.length > 0) sortedAsc[sortedAsc.length-1].consumo = 0;

              // --- L√ìGICA DE AGREGACI√ìN SEMANAL ---
              const weeklyMap = {};
              sortedAsc.forEach(item => {
                if (item.consumo > 0) {
                  // Parsear fechaTurno (DD-MM-YYYY)
                  const [dd, mm, yyyy] = item.fechaTurno.split('-');
                  const d = new Date(yyyy, mm - 1, dd);
                  
                  // Obtener Lunes de la semana
                  const day = d.getDay();
                  const diff = d.getDate() - day + (day === 0 ? -6 : 1);
                  const monday = new Date(d);
                  monday.setDate(diff);
                  monday.setHours(0,0,0,0);
                  
                  const sortKey = monday.getTime();
                  const label = `${monday.getDate().toString().padStart(2,'0')}/${(monday.getMonth()+1).toString().padStart(2,'0')}`;
                  
                  if (!weeklyMap[sortKey]) weeklyMap[sortKey] = { label: label, total: 0, sort: sortKey };
                  weeklyMap[sortKey].total += item.consumo;
                }
              });
              const weeklyData = Object.values(weeklyMap).sort((a, b) => a.sort - b.sort);
              updateWeeklyChart(weeklyData);

              // --- L√ìGICA DE RELLENO (PADDING) PARA PAGINACI√ìN COHERENTE ---
              // Agrupar por fechaTurno para asegurar 3 turnos por d√≠a
              const byDate = {};
              itemsToShow.forEach(item => {
                if (!byDate[item.fechaTurno]) byDate[item.fechaTurno] = [];
                byDate[item.fechaTurno].push(item);
              });

              const finalDisplayList = [];
              // Obtener fechas √∫nicas y ordenarlas descendente
              const uniqueDates = Object.keys(byDate).sort((a, b) => {
                 const pa = a.split('-'); const pb = b.split('-');
                 return new Date(pb[2], pb[1]-1, pb[0]) - new Date(pa[2], pa[1]-1, pa[0]);
              });

              uniqueDates.forEach(dateStr => {
                 const dayItems = byDate[dateStr];
                 
                 // Buscar existentes
                 const t1 = dayItems.find(i => i.turno.toLowerCase().includes('turno 1'));
                 const t2 = dayItems.find(i => i.turno.toLowerCase().includes('turno 2'));
                 const t3 = dayItems.find(i => i.turno.toLowerCase().includes('turno 3'));

                 // Helper para placeholder
                 const getPlaceholder = (name, order) => {
                    const parts = dateStr.split('-');
                    const d = new Date(parts[2], parts[1]-1, parts[0]);
                    return {
                      fecha: dateStr,
                      hora: '',
                      fechaTurno: dateStr,
                      turno: name,
                      energiaStr: '---',
                      energiaVal: 0,
                      consumo: 0,
                      shiftSortKey: d.getTime() + (order * 3600000),
                      isPlaceholder: true
                    };
                 };

                 // Insertar en orden T3, T2, T1
                 finalDisplayList.push(t3 || getPlaceholder('Turno 3 (23:00-08:00)', 3));
                 finalDisplayList.push(t2 || getPlaceholder('Turno 2 (15:30-23:00)', 2));
                 finalDisplayList.push(t1 || getPlaceholder('Turno 1 (08:00-15:30)', 1));
              });

              // Guardar datos procesados y renderizar tabla
              kwhData = finalDisplayList;
              currentKwhPage = 1;
              renderKwhTable();

              if (itemsToShow.length > 0) {
              } else {
                loader.style.display = "none";
                status.textContent = "No se encontraron datos v√°lidos.";
                status.style.display = "block";
              }
            } else {
              loader.style.display = "none";
              status.textContent = "No se encontraron datos hist√≥ricos.";
              status.style.display = "block";
            }
          } catch (e) {
            console.error("Error procesando historial KWH:", e);
            loader.style.display = "none";
            status.textContent = "Error al procesar los datos recibidos.";
            status.style.display = "block";
          }
        }
      }
    }

    // Manejo del topic Viento_STS1
    if (topic === 'Viento_STS1') {
      const value = parseFloat(message.toString());
      if (!isNaN(value)) {
        // Actualizar valor en m/s
        document.getElementById('Viento_STS1').innerHTML = `${value.toFixed(2)} <span class="sts-unit">m/s</span>`;

        // Conversiones: 1 m/s = 1.94384 nudos, 1 m/s = 3.6 km/h
        const knots = (value * 1.94384).toFixed(2);
        const kmh = (value * 3.6).toFixed(2);
        document.getElementById('topic8').innerHTML = `${knots} <span class="sts-unit">Nudos</span> | ${kmh} <span class="sts-unit">km/h</span>`;
        document.getElementById('topic8Loader').style.display = 'none';
        document.getElementById('topic8Content').style.display = 'block';

        // L√≥gica de colores para el recuadro
        const cell = document.getElementById('topic8-cell');
        if (value >= 25) {
          cell.style.backgroundColor = '#dc3545'; // Rojo
          cell.style.color = '#fff';
        } else if (value >= 20) {
          cell.style.backgroundColor = '#fd7e14'; // Naranja
          cell.style.color = '#fff';
        } else if (value >= 18) {
          cell.style.backgroundColor = '#ffc107'; // Amarillo
          cell.style.color = '#333'; // Texto oscuro para contraste
        } else {
          cell.style.backgroundColor = '#28a745'; // Verde
          cell.style.color = '#fff';
        }
      }
    }

    // Manejo de los topics de KWH
    const kwhTopics = {
      'KWH_STS1': 'kwh_sts1',
      'KWH_STS2': 'kwh_sts2',
      'KWH_STS3': 'kwh_sts3',
      'KWH_STS4': 'kwh_sts4',
      'KWH_STS5': 'kwh_sts5'
    };

    if (kwhTopics[topic]) {
      const value = parseFloat(message.toString());
      if (!isNaN(value)) {
        const elementId = kwhTopics[topic];
        document.getElementById(elementId).innerHTML = `${value.toFixed(2)} <span class="sts-unit">kWh</span>`;
      }
    }

    // Manejo de la recepci√≥n del historial de peaks (desde CSV/Base de datos)
    if (topic === 'HISTORIAL_PEAKS') {
      try {
        const historyData = JSON.parse(message.toString());
        
        // Caso 1: Array completo (Carga inicial o masiva)
        if (Array.isArray(historyData)) {
          // Actualizamos la variable local con los datos recibidos del servidor
          peakHistoryData = historyData;
          renderTable(); // Refrescamos la tabla visualmente
          document.getElementById('historyIndicator').textContent = `üóÇÔ∏è Historial: Cargado (${peakHistoryData.length} reg.)`;
          document.getElementById('historyIndicator').style.color = "#28a745"; // Verde
          document.getElementById('mainTableLoader').style.display = 'none';
          document.getElementById('peakChartLoader').style.display = 'none';
          updateLastPeakWidget(); // Actualizar widget
          updatePeakChart();
          updateHistoryDateRange();
        } 
        // Caso 2: Registro individual (Formato col1, col2, col3)
        else if (historyData.col1 && historyData.col2 && historyData.col3) {
          const fullDate = `${historyData.col1} ${historyData.col2}`;
          const value = parseFloat(historyData.col3);
          
          // Evitar duplicados al recibir historial (verifica si ya existe en la lista)
          const isDuplicate = peakHistoryData.some(item => item.date === fullDate && Math.abs(item.value - value) < 0.01);
          if (isDuplicate) {
            document.getElementById('mainTableLoader').style.display = 'none';
            return;
          }

          peakHistoryData.unshift({ date: fullDate, value: value });
          
          if (currentPage === 1) renderTable();
          
          document.getElementById('historyIndicator').textContent = `üóÇÔ∏è Historial: Cargado (${peakHistoryData.length} reg.)`;
          document.getElementById('historyIndicator').style.color = "#28a745";
          updateLastPeakWidget();
          updatePeakChart();
          updateHistoryDateRange();
          document.getElementById('mainTableLoader').style.display = 'none';
          document.getElementById('peakChartLoader').style.display = 'none';
        }
      } catch (e) { 
        console.error("Error procesando historial peaks:", e);
        document.getElementById('mainTableLoader').style.display = 'none';
        document.getElementById('lastPeakLoader').style.display = 'none';
        document.getElementById('lastPeakContent').style.display = 'block';
      }
    }
  });
</script>
</body>
</html>
