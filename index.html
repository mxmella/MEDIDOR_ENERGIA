// Suscribirse a todos los tópicos
client.on('connect', () => {
  console.log('Conectado al broker MQTT');
  client.subscribe(['vientosts1', 'vientosts2', 'vientosts3', 'vientosts4', 'vientosts5']);
});

const data = {
  labels: [], 
  datasets: [
    {
      label: 'vientosts1',
      data: [],
      borderColor: 'rgb(255, 99, 132)', // rojo
      fill: false,
      tension: 0.1,
      pointRadius: 4,
      pointHoverRadius: 6
    },
    {
      label: 'vientosts2',
      data: [],
      borderColor: 'rgb(54, 162, 235)', // azul
      fill: false,
      tension: 0.1,
      pointRadius: 4,
      pointHoverRadius: 6
    },
    {
      label: 'vientosts3',
      data: [],
      borderColor: 'rgb(255, 206, 86)', // amarillo
      fill: false,
      tension: 0.1,
      pointRadius: 4,
      pointHoverRadius: 6
    },
    {
      label: 'vientosts4',
      data: [],
      borderColor: 'rgb(75, 192, 192)', // verde agua
      fill: false,
      tension: 0.1,
      pointRadius: 4,
      pointHoverRadius: 6
    },
    {
      label: 'vientosts5',
      data: [],
      borderColor: 'rgb(153, 102, 255)', // morado
      fill: false,
      tension: 0.1,
      pointRadius: 4,
      pointHoverRadius: 6
    }
  ]
};

client.on('message', (topic, message) => {
  const value = parseFloat(message.toString());
  if (!isNaN(value)) {
    const now = new Date();
    const timeLabel = now.toLocaleTimeString();
    const fullDate = now.toLocaleString();

    // Guardar datos para tabla SIEMPRE - aquí, por simplicidad,
    // guardamos solo datos del tópico 'vientosts1' en tabla (o puedes adaptar)
    if (topic === 'vientosts1') {
      allData.push({datetime: fullDate, value: value});
      if(allData.length > 1000) allData.shift();
    }

    updatePaginationButtons();
    renderTablePage(currentPage);

    if (!paused) {
      // Solo agregar la nueva hora una vez (para sincronizar los datasets)
      if (!data.labels.includes(timeLabel)) {
        data.labels.push(timeLabel);
        if (data.labels.length > 20) {
          data.labels.shift();
        }
      }

      // Encuentra índice del dataset según topic
      const datasetIndex = {
        'vientosts1': 0,
        'vientosts2': 1,
        'vientosts3': 2,
        'vientosts4': 3,
        'vientosts5': 4
      }[topic];

      if (datasetIndex !== undefined) {
        data.datasets[datasetIndex].data.push(value);
        if (data.datasets[datasetIndex].data.length > 20) {
          data.datasets[datasetIndex].data.shift();
        }
      }

      myChart.update();
    }
  }
});

