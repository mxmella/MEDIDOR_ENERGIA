<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sistema de Gesti√≥n Energ√©tica</title>
  <link rel="icon" href="logo puerto.png" type="image/png">

  <!-- Chart.js + Zoom Plugin -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <link rel="stylesheet" href="style.css">
  
</head>
<body>
  <div id="print-page-one">
  <header class="main-header">
    <div class="header-left">
      <img id="logo-fijo" src="logo puerto.png" alt="Logo" />
      <div class="header-info">
        <h1>Sistema de Gesti√≥n Energ√©tica</h1>
        <div id="liveClock" class="header-clock">--</div>
        <div id="reportTimestamp" class="print-only"></div>
      </div>
    </div>
    <div class="header-controls">
      <div id="connectionStatus"><span class="status-led"></span><span id="connText">Desconectado</span></div>
      <button id="reportBtn">üìÑ Informe</button>
      <button id="darkModeToggle" title="Alternar modo oscuro">Modo oscuro</button>
    </div>
  </header>

  <!-- Recuadros Principales -->
  <div class="dashboard-grid main-metrics">
    <div id="topic1-cell" class="sts-box" style="background: linear-gradient(135deg, #0a72c1, #0a3d66); cursor: pointer;" onclick="openCgeModal()">
      <!-- Icono Rayo -->
      <svg class="card-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"></path></svg>
      <div class="sts-title" style="color: #fff;">Medidor CGE</div>
      <div id="topic1Loader" class="loader" style="display: block; border-color: rgba(255,255,255,0.2); border-top-color: #fff;"></div>
      <div id="topic1Content" style="display: none;">
        <div id="topic1" class="sts-data">-- <span class="sts-unit">Amp</span></div>
      </div>
      <div class="card-action-prompt">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3l7.07 16.97 2.51-7.39 7.39-2.51L3 3z"></path><path d="M13 13l6 6"></path></svg>
        <span>Ver Detalles</span>
      </div>
    </div>
    <div id="topic2-cell" class="sts-box" style="background: linear-gradient(135deg, #ffc72c, #e0a800);">
      <!-- Icono Actividad/Pulso -->
      <svg class="card-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>
      <div class="sts-title" style="color: #fff;">Consumo Gr√∫as</div>
      <div id="topic2Loader" class="loader" style="display: block; border-color: rgba(255,255,255,0.2); border-top-color: #fff;"></div>
      <div id="topic2Content" style="display: none;">
        <div id="topic2" class="sts-data">-- <span class="sts-unit">Amp</span></div>
      </div>
    </div>
    <div id="last-peak-cell" class="sts-box" style="background: linear-gradient(135deg, #dc3545, #c82333);">
      <!-- Icono Tendencia Subida -->
      <svg class="card-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>
      <div class="sts-title" style="color: #fff;">√öltimo Peak</div>
      <div id="lastPeakLoader" class="loader" style="display: block; border-color: rgba(255,255,255,0.2); border-top-color: #fff;"></div>
      <div id="lastPeakContent" style="display: none;">
        <div id="lastPeakValue" class="sts-data">-- <span class="sts-unit">Amp</span></div>
        <div id="lastPeakDate" class="sts-data" style="font-size: 1.1rem; margin-top: 5px; font-weight: 400;">--</div>
      </div>
    </div>
    <div id="topic8-cell" class="sts-box" style="background: linear-gradient(135deg, #28a745, #1c6b2e);">
      <!-- Icono Viento -->
      <svg class="card-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9.59 4.59A2 2 0 1 1 11 8H2m10.59 11.41A2 2 0 1 0 14 16H2m15.73-8.27A2.5 2.5 0 1 1 19.5 12H2"/></svg>
      <div class="sts-title">Viento</div>
      <div id="topic8Loader" class="loader" style="display: block; border-color: rgba(255,255,255,0.2); border-top-color: #fff;"></div>
      <div id="topic8Content" style="display: none;">
        <div id="Viento_STS1" class="sts-data" style="font-size: 2.5rem;">-- <span class="sts-unit">m/s</span></div>
        <div id="topic8" class="sts-data" style="font-size: 1.2rem; margin-top: 5px;">-- <span class="sts-unit">Nudos</span> | -- <span class="sts-unit">km/h</span></div>
      </div>
      <!-- <div class="slow-down-legend" style="display: none;">GRUA EN SLOW DOWN</div> -->
    </div>
  </div>
  
   <!-- Nuevos topics I_STS1, I_STS2, I_STS3, I_STS4, I_STS5 -->
  <div class="dashboard-grid">
    <div id="topic3-cell" class="sts-box">
      <!-- Icono Ancla (STS1) -->
      <svg class="card-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="5" r="3"></circle><line x1="12" y1="22" x2="12" y2="8"></line><path d="M5 12H2a10 10 0 0 0 20 0h-3"></path></svg>
      <div class="sts-title">STS1</div>
      <div id="topic3Loader" class="loader" style="display: block; border-color: rgba(255,255,255,0.2); border-top-color: #fff;"></div>
      <div id="topic3Content" style="display: none;">
        <div id="topic3" class="sts-data">-- <span class="sts-unit">Amp</span></div>
        <div id="kwh_sts1" class="sts-data">-- <span class="sts-unit">kWh</span></div>
        <div class="slow-down-legend" style="display: none;">GRUA EN SLOW DOWN</div>
        <div id="last_slow_sts1" class="last-slow-info"></div>
        <button class="btn-history" onclick="openHistory(1)"><span class="btn-icon">üìä</span> Ver Historial KWH</button>
        <button class="btn-history" onclick="openSlowDownModal(1)"><span class="btn-icon">üìâ</span> Gr√°fico Slow Down</button>
      </div>
    </div>
    <div id="topic4-cell" class="sts-box">
      <!-- Icono Ancla (STS2) -->
      <svg class="card-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="5" r="3"></circle><line x1="12" y1="22" x2="12" y2="8"></line><path d="M5 12H2a10 10 0 0 0 20 0h-3"></path></svg>
      <div class="sts-title">STS2</div>
      <div id="topic4Loader" class="loader" style="display: block; border-color: rgba(255,255,255,0.2); border-top-color: #fff;"></div>
      <div id="topic4Content" style="display: none;">
        <div id="topic4" class="sts-data">-- <span class="sts-unit">Amp</span></div>
        <div id="kwh_sts2" class="sts-data">-- <span class="sts-unit">kWh</span></div>
        <div class="slow-down-legend" style="display: none;">GRUA EN SLOW DOWN</div>
        <div id="last_slow_sts2" class="last-slow-info"></div>
        <button class="btn-history" onclick="openHistory(2)"><span class="btn-icon">üìä</span> Ver Historial KWH</button>
        <button class="btn-history" onclick="openSlowDownModal(2)"><span class="btn-icon">üìâ</span> Gr√°fico Slow Down</button>
      </div>
    </div>
    <div id="topic5-cell" class="sts-box">
      <!-- Icono Ancla (STS3) -->
      <svg class="card-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="5" r="3"></circle><line x1="12" y1="22" x2="12" y2="8"></line><path d="M5 12H2a10 10 0 0 0 20 0h-3"></path></svg>
      <div class="sts-title">STS3</div>
      <div id="topic5Loader" class="loader" style="display: block; border-color: rgba(255,255,255,0.2); border-top-color: #fff;"></div>
      <div id="topic5Content" style="display: none;">
        <div id="topic5" class="sts-data">-- <span class="sts-unit">Amp</span></div>
        <div id="kwh_sts3" class="sts-data">-- <span class="sts-unit">kWh</span></div>
        <div class="slow-down-legend" style="display: none;">GRUA EN SLOW DOWN</div>
        <div id="last_slow_sts3" class="last-slow-info"></div>
        <button class="btn-history" onclick="openHistory(3)"><span class="btn-icon">üìä</span> Ver Historial KWH</button>
        <button class="btn-history" onclick="openSlowDownModal(3)"><span class="btn-icon">üìâ</span> Gr√°fico Slow Down</button>
      </div>
    </div>
    <div id="topic6-cell" class="sts-box">
      <!-- Icono Ancla (STS4) -->
      <svg class="card-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="5" r="3"></circle><line x1="12" y1="22" x2="12" y2="8"></line><path d="M5 12H2a10 10 0 0 0 20 0h-3"></path></svg>
      <div class="sts-title">STS4</div>
      <div id="topic6Loader" class="loader" style="display: block; border-color: rgba(255,255,255,0.2); border-top-color: #fff;"></div>
      <div id="topic6Content" style="display: none;">
        <div id="topic6" class="sts-data">-- <span class="sts-unit">Amp</span></div>
        <div id="kwh_sts4" class="sts-data">-- <span class="sts-unit">kWh</span></div>
        <div class="slow-down-legend" style="display: none;">GRUA EN SLOW DOWN</div>
        <div id="last_slow_sts4" class="last-slow-info"></div>
        <button class="btn-history" onclick="openHistory(4)"><span class="btn-icon">üìä</span> Ver Historial KWH</button>
        <button class="btn-history" onclick="openSlowDownModal(4)"><span class="btn-icon">üìâ</span> Gr√°fico Slow Down</button>
      </div>
    </div>
    <div id="topic7-cell" class="sts-box">
      <!-- Icono Ancla (STS5) -->
      <svg class="card-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="5" r="3"></circle><line x1="12" y1="22" x2="12" y2="8"></line><path d="M5 12H2a10 10 0 0 0 20 0h-3"></path></svg>
      <div class="sts-title">STS5</div>
      <div id="topic7Loader" class="loader" style="display: block; border-color: rgba(255,255,255,0.2); border-top-color: #fff;"></div>
      <div id="topic7Content" style="display: none;">
        <div id="topic7" class="sts-data">-- <span class="sts-unit">Amp</span></div>
        <div id="kwh_sts5" class="sts-data">-- <span class="sts-unit">kWh</span></div>
        <div class="slow-down-legend" style="display: none;">GRUA EN SLOW DOWN</div>
        <div id="last_slow_sts5" class="last-slow-info"></div>
        <button class="btn-history" onclick="openHistory(5)"><span class="btn-icon">üìä</span> Ver Historial KWH</button>
        <button class="btn-history" onclick="openSlowDownModal(5)"><span class="btn-icon">üìâ</span> Gr√°fico Slow Down</button>
      </div>
    </div>
  </div>

  <!-- Modal para Detalles Medidor CGE -->
  <div id="cgeModal" class="modal">
    <div class="modal-content" style="max-width: 1600px; padding: 0; border: none; border-radius: 12px;">
      <div class="modal-header-custom">
        <h2><span>‚ö°</span> Detalles Medidor CGE</h2>
        <span class="close-modal" onclick="closeCgeModal()" style="color: #fff; opacity: 0.8; float: none;">&times;</span>
      </div>
      <div class="modal-body-custom">
        <div class="dashboard-grid" style="max-width: 100%;">
           <div class="sts-box" style="background: linear-gradient(135deg, #0a5a9c, #0a3d66); cursor: pointer;" onclick="openCurrentModal()">
              <div class="sts-title" style="font-size: 0.9rem;">Corriente Total</div>
              <div id="val_CGE_AMP" class="sts-data">-- <span class="sts-unit">Amp</span></div>
              <div style="font-size: 0.75rem; opacity: 0.9; margin-top: 5px;">Amperaje Instant√°neo</div>
              <div class="card-action-prompt">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3l7.07 16.97 2.51-7.39 7.39-2.51L3 3z"></path><path d="M13 13l6 6"></path></svg>
                <span>Ver Fases</span>
              </div>
           </div>
           <div class="sts-box" style="background: linear-gradient(135deg, #0a5a9c, #0a3d66); cursor: pointer;" onclick="openVoltageModal()">
              <div class="sts-title" style="font-size: 0.9rem;">Voltaje Promedio L-L</div>
              <div id="val_VOLT_L_L_AVG" class="sts-data">-- <span class="sts-unit">kV</span></div>
              <div style="font-size: 0.75rem; opacity: 0.9; margin-top: 5px;">Media Tensi√≥n</div>
              <div class="card-action-prompt">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3l7.07 16.97 2.51-7.39 7.39-2.51L3 3z"></path><path d="M13 13l6 6"></path></svg>
                <span>Ver Fases</span>
              </div>
           </div>
           <div id="card_ACTIVE_TOTAL" class="sts-box" style="background: linear-gradient(135deg, #0a5a9c, #0a3d66);">
              <div class="sts-title" style="font-size: 0.9rem;">Potencia Activa Total</div>
              <div id="val_ACTIVE_TOTAL" class="sts-data">-- <span class="sts-unit">kW</span></div>
              <div id="desc_ACTIVE_TOTAL" style="font-size: 0.75rem; opacity: 0.9; margin-top: 5px;">Active Power (Real)</div>
           </div>
           <div class="sts-box" style="background: linear-gradient(135deg, #0a5a9c, #0a3d66);">
              <div class="sts-title" style="font-size: 0.9rem;">Potencia Reactiva Total</div>
              <div id="val_REACTIVE_TOTAL" class="sts-data">-- <span class="sts-unit">kVAR</span></div>
              <div style="font-size: 0.75rem; opacity: 0.9; margin-top: 5px;">Reactive Power</div>
           </div>
           <div class="sts-box" style="background: linear-gradient(135deg, #0a5a9c, #0a3d66);">
              <div class="sts-title" style="font-size: 0.9rem;">Potencia Aparente Total</div>
              <div id="val_APARENTE_TOTAL" class="sts-data">-- <span class="sts-unit">kVA</span></div>
              <div style="font-size: 0.75rem; opacity: 0.9; margin-top: 5px;">Apparent Power (Total)</div>
           </div>
           <div class="sts-box" style="background: linear-gradient(135deg, #0a5a9c, #0a3d66);">
              <div class="sts-title" style="font-size: 0.9rem;">Factor de Potencia</div>
              <div id="val_FACTOR_POTENCIA" class="sts-data">--</div>
              <div style="font-size: 0.75rem; opacity: 0.9; margin-top: 5px;">Eficiencia (kW / kVA)</div>
           </div>
           <div class="sts-box" style="background: linear-gradient(135deg, #0a5a9c, #0a3d66);">
              <div class="sts-title" style="font-size: 0.9rem;">Desbalance Voltaje L-N</div>
              <div id="val_VOLT_UB_L_N_WOR" class="sts-data">-- <span class="sts-unit">%</span></div>
              <div style="font-size: 0.75rem; opacity: 0.9; margin-top: 5px;">Volt Unbalance Worst</div>
           </div>
           <div class="sts-box" style="background: linear-gradient(135deg, #0a5a9c, #0a3d66);">
              <div class="sts-title" style="font-size: 0.9rem;">Desbalance Corriente (Worst)</div>
              <div id="val_CU_UN_WOR" class="sts-data">-- <span class="sts-unit">%</span></div>
              <div style="font-size: 0.75rem; opacity: 0.9; margin-top: 5px;">Current Unbalance</div>
           </div>
        </div>

        <!-- Gr√°ficos de Tendencia -->
        <h3 style="margin-top: 30px; margin-bottom: 15px; font-size: 1.2rem; border-bottom: 1px solid #eee; padding-bottom: 10px;">
            üìà Tendencias de Calidad de Energ√≠a
        </h3>
        
        <div class="dashboard-grid" style="grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); max-width: 100%;">
            <div class="chart-container-modal">
                <canvas id="cgePowerChart"></canvas>
            </div>
            <div class="chart-container-modal">
                <canvas id="cgeUnbalanceChart"></canvas>
            </div>
        </div>
        <div class="chart-container-modal">
            <canvas id="cgeVoltageChart"></canvas>
        </div>

        <!-- Secci√≥n de An√°lisis y Gu√≠a -->
        <button type="button" id="btnGuide" class="collapsible-btn" onclick="toggleGuide()">
            <span>üìö Gu√≠a de An√°lisis y Unidades</span>
            <span id="guideArrow" style="font-size: 0.8em;">‚ñº</span>
        </button>
        
        <div id="guideContent" class="collapsible-content">
          <div style="overflow-x: auto; margin-top: 15px; margin-bottom: 15px;">
          <table class="analysis-table">
            <thead>
              <tr>
                <th>Variable</th>
                <th>Unidad</th>
                <th>Interpretaci√≥n / Estado</th>
              </tr>
            </thead>
            <tbody>
              <tr><td><strong>Voltaje Promedio L-L</strong></td><td>Kilovoltios (kV)</td><td>Operando en Media Tensi√≥n (Rango de 15kV).</td></tr>
              <tr><td><strong>Potencia Activa Total</strong></td><td>Kilovatios (kW)</td><td>Es el consumo real que factura la compa√±√≠a.</td></tr>
              <tr><td><strong>Potencia Reactiva Total</strong></td><td>kVAR</td><td>Energ√≠a necesaria para magnetizaci√≥n (motores/transf.).</td></tr>
              <tr><td><strong>Potencia Aparente Total</strong></td><td>kVA</td><td>Carga total que soporta tu cableado y transformador.</td></tr>
              <tr><td><strong>Factor de Potencia</strong></td><td>Adimensional</td><td>Excelente si &gt; 0.93 (1.0 es ideal). Evita multas.</td></tr>
              <tr><td><strong>Desbalance Corriente</strong></td><td>Porcentaje (%)</td><td>Muy bajo (&lt; 2%). Cargas perfectamente distribuidas.</td></tr>
              <tr><td><strong>Desbalance Voltaje</strong></td><td>Porcentaje (%)</td><td>Suministro de red muy estable.</td></tr>
            </tbody>
          </table>
          </div>
        </div>

        <button type="button" id="btnFp" class="collapsible-btn" onclick="toggleFp()" style="margin-top: 15px;">
            <span>‚úÖ Verificaci√≥n del Factor de Potencia FP</span>
            <span id="fpArrow" style="font-size: 0.8em;">‚ñº</span>
        </button>
        
        <div id="fpContent" class="collapsible-content">
          <div class="fp-verification" style="margin-top: 15px; margin-bottom: 15px;">
          <div style="margin-bottom: 8px;">El c√°lculo que realiza el sistema es:</div>
          <div style="font-family: monospace; background: rgba(0,0,0,0.05); padding: 8px; border-radius: 6px; display: inline-block; margin-bottom: 8px; font-weight: bold;">
             FP = (kW)/(kVA)
          </div>
          <div style="font-size: 0.95em; opacity: 0.95; line-height: 1.5;">
             Ejemplo con tus datos: <br>
             <span id="fpExampleCalc">-- kW / -- kVA = <strong>--</strong></span> <br>
             <em>Este valor es ideal. Generalmente, cualquier valor por encima de 0.93 evita multas por energ√≠a reactiva, y t√∫ est√°s pr√°cticamente en el tope de eficiencia.</em>
          </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Modal para Detalles de Voltaje por Fase -->
  <div id="voltageModal" class="modal" style="z-index: 10000;">
    <div class="modal-content" style="max-width: 900px; padding: 0; border: none; border-radius: 12px;">
      <div class="modal-header-custom">
        <h2><span>‚ö°</span> Voltajes de L√≠nea</h2>
        <span class="close-modal" onclick="closeVoltageModal()" style="color: #fff; opacity: 0.8; float: none;">&times;</span>
      </div>
      <div class="modal-body-custom">
        <h3 style="margin-top: 0; margin-bottom: 10px; color: #0a3d66; font-size: 1rem;">Voltajes de L√≠nea (L-L)</h3>
        <div class="dashboard-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); margin-bottom: 10px;">
           <div class="sts-box" style="background: #0a72c1;">
              <div class="sts-title" style="font-size: 0.9rem;">Voltaje A-B</div>
              <div id="val_VOLTAJE_A-B" class="sts-data">-- <span class="sts-unit">kV</span></div>
           </div>
           <div class="sts-box" style="background: #0a72c1;">
              <div class="sts-title" style="font-size: 0.9rem;">Voltaje B-C</div>
              <div id="val_VOLTAJE_B-C" class="sts-data">-- <span class="sts-unit">kV</span></div>
           </div>
           <div class="sts-box" style="background: #0a72c1;">
              <div class="sts-title" style="font-size: 0.9rem;">Voltaje C-A</div>
              <div id="val_VOLTAJE_C-A" class="sts-data">-- <span class="sts-unit">kV</span></div>
           </div>
        </div>
        <div class="chart-container-modal" style="height: 250px; margin-bottom: 20px;">
            <canvas id="voltagePhasesChart"></canvas>
        </div>

        <h3 style="margin-top: 10px; margin-bottom: 10px; color: #0a3d66; font-size: 1rem; border-top: 1px solid #eee; padding-top: 20px;">Voltajes de Fase (L-N)</h3>
        <div class="dashboard-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); margin-bottom: 10px;">
           <div class="sts-box" style="background: #17a2b8;">
              <div class="sts-title" style="font-size: 0.9rem;">Voltaje A-N</div>
              <div id="val_VOLTAJE_A-N" class="sts-data">-- <span class="sts-unit">kV</span></div>
           </div>
           <div class="sts-box" style="background: #17a2b8;">
              <div class="sts-title" style="font-size: 0.9rem;">Voltaje B-N</div>
              <div id="val_VOLTAJE_B-N" class="sts-data">-- <span class="sts-unit">kV</span></div>
           </div>
           <div class="sts-box" style="background: #17a2b8;">
              <div class="sts-title" style="font-size: 0.9rem;">Voltaje C-N</div>
              <div id="val_VOLTAJE_C-N" class="sts-data">-- <span class="sts-unit">kV</span></div>
           </div>
           <div class="sts-box" style="background: #17a2b8;">
              <div class="sts-title" style="font-size: 0.9rem;">Promedio L-N</div>
              <div id="val_VOLTAJE_TOTAL_L-N" class="sts-data">-- <span class="sts-unit">kV</span></div>
           </div>
        </div>

        <div class="chart-container-modal" style="height: 250px;">
            <canvas id="voltageLNChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para Detalles de Corriente -->
  <div id="currentModal" class="modal" style="z-index: 10000;">
    <div class="modal-content" style="max-width: 900px; padding: 0; border: none; border-radius: 12px;">
      <div class="modal-header-custom">
        <h2><span>‚ö°</span> Corrientes del Sistema</h2>
        <span class="close-modal" onclick="closeCurrentModal()" style="color: #fff; opacity: 0.8; float: none;">&times;</span>
      </div>
      <div class="modal-body-custom">
        <h3 style="margin-top: 0; margin-bottom: 10px; color: #0a3d66; font-size: 1rem;">Corrientes de Fase</h3>
        <div class="dashboard-grid" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); margin-bottom: 10px;">
           <div class="sts-box" style="background: #0a72c1;">
              <div class="sts-title" style="font-size: 0.9rem;">Fase A</div>
              <div id="val_CORRIENTE_A" class="sts-data">-- <span class="sts-unit">A</span></div>
           </div>
           <div class="sts-box" style="background: #0a72c1;">
              <div class="sts-title" style="font-size: 0.9rem;">Fase B</div>
              <div id="val_CORRIENTE_B" class="sts-data">-- <span class="sts-unit">A</span></div>
           </div>
           <div class="sts-box" style="background: #0a72c1;">
              <div class="sts-title" style="font-size: 0.9rem;">Fase C</div>
              <div id="val_CORRIENTE_C" class="sts-data">-- <span class="sts-unit">A</span></div>
           </div>
        </div>
        <div class="chart-container-modal" style="height: 250px; margin-bottom: 20px;">
            <canvas id="currentPhasesChart"></canvas>
        </div>

        <h3 style="margin-top: 10px; margin-bottom: 10px; color: #0a3d66; font-size: 1rem; border-top: 1px solid #eee; padding-top: 20px;">Corrientes Neutro y Tierra</h3>
        <div class="dashboard-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); margin-bottom: 10px;">
           <div class="sts-box" style="background: #17a2b8;">
              <div class="sts-title" style="font-size: 0.9rem;">Neutro (N)</div>
              <div id="val_CORRIENTE_N" class="sts-data">-- <span class="sts-unit">A</span></div>
           </div>
           <div class="sts-box" style="background: #6c757d;">
              <div class="sts-title" style="font-size: 0.9rem;">Tierra (G)</div>
              <div id="val_CORRIENTE_TIERRA" class="sts-data">-- <span class="sts-unit">A</span></div>
           </div>
        </div>

        <div class="chart-container-modal" style="height: 250px;">
            <canvas id="currentNGChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <div class="print-footer-page1">
    ¬© 2026 Desarrollado por Horacio Mella O. ‚Äì Ing. Electr√≥nico / Ing. El√©ctrico ‚Äì Depto. Mar√≠timo
  </div>
  </div>

  <!-- ------------ -->
  <div id="print-page-two">

  <!-- Alertas -->
  <div id="alertContainer">‚ö†Ô∏è Alerta: Valor alto detectado!</div>

  <div class="main-chart-wrapper">
    <h2 class="chart-title">Monitor de Consumo en Tiempo Real</h2>
    <div class="chart-box-container">
      <div id="myChartLoader" class="loader" style="display: block; position: absolute; top: 45%; left: 50%; transform: translate(-50%, -50%); z-index: 10;"></div>
      <canvas id="myChart"></canvas> 
    </div>
  </div>
  
  <!-- Contenedor para Gr√°fico y Tabla de Peaks -->
  <div class="peaks-section-container">
    <h2 class="chart-title">Historial de Eventos y Peaks</h2>
    <div class="peaks-inner-row">
    <!-- Lado Izquierdo: Gr√°fico -->
    <div class="peak-chart-wrapper">
      <h3 id="peakChartTitle" style="text-align: center; margin-top: 0;">Tendencia Gr√°fica</h3>
      <div class="chart-canvas-container">
        <div id="peakChartLoader" class="loader" style="display: block; position: absolute; top: 45%; left: 50%; transform: translate(-50%, -50%); z-index: 10;"></div>
        <canvas id="peakChart"></canvas>
      </div>
    </div>

    <!-- Lado Derecho: Tabla -->
    <div class="peak-table-wrapper">
      <div style="text-align: center; margin-bottom: 15px;">
        <h3 style="margin: 0 0 5px 0;">Registro Detallado</h3>
        <div id="dataStatus" style="font-size: 0.9rem; font-weight: 600; opacity: 0.9;">
          <span id="historyIndicator" style="transition: color 0.3s;">üóÇÔ∏è Historial: Esperando...</span>
        </div>
        <div id="mainTableLoader" class="loader" style="display: block;"></div>
        <div id="historyDateRange" style="font-size: 0.8rem; opacity: 0.8; margin-top: 5px; display: none;">
          Muestreo desde <strong id="firstDate">--</strong> hasta <strong id="lastDate">--</strong>
        </div>
      </div>
      <div class="table-container">
        <table id="peakHistoryTable">
          <thead>
            <tr>
              <th scope="col">Fecha y Hora</th>
              <th scope="col">Valor del Peak (Amp)</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="pagination">
        <button id="btnPrev" disabled>Anterior</button>
        <span id="pageInfo">P√°gina 1 de 1</span>
        <button id="btnNext" disabled>Siguiente</button>
      </div>
    </div>
    </div>
  </div>

  <footer>
    ¬© 2026 Desarrollado por Horacio Mella O. ‚Äì Ing. Electr√≥nico / Ing. El√©ctrico ‚Äì Depto. Mar√≠timo
  </footer>

  </div>

  <!-- Modal para Historial KWH -->
  <div id="kwhModal" class="modal">
    <div class="modal-content">
      <div class="print-header-kwh" style="display: none;">
        <img src="logo puerto.png" alt="Logo">
        <h1>Sistema de Gesti√≥n Energ√©tica</h1>
      </div>
      <span class="close-modal" onclick="closeHistory()">&times;</span>
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h2 id="modalTitle" style="margin: 0; display: flex; align-items: center; gap: 10px;"><span>üìä</span> Historial KWH</h2>
        <button class="btn-export" onclick="printKwhReport()">üìÑ Generar Informe</button>
      </div>
      <div id="kwhReportTimestamp" class="print-only" style="margin-bottom: 10px;"></div>
      
      <div style="display: flex; gap: 15px; align-items: flex-end; margin-bottom: 20px;">
          <div style="flex: 1;">
            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Seleccionar Fecha:</label>
            <input type="date" id="kwhDateInput" style="padding: 8px; border-radius: 6px; border: 1px solid #ccc; width: 100%; font-size: 1rem;">
          </div>
          <button class="btn-calc" style="width: auto; padding: 0 25px;" onclick="requestKwhHistoryData()">Consultar</button>
      </div>
      
      <div class="charts-wrapper">
        <div class="chart-container-modal"><canvas id="kwhShiftChart"></canvas></div>
      </div>

      <div id="dailyTotalDisplay" class="daily-total-box">
        <div id="dailyTotalLabel" class="daily-total-label">Consumo Total D√≠a</div>
        <div id="dailyTotalValue" class="daily-total-value">-- kWh</div>
        <div style="font-size: 0.85rem; margin-top: 10px; opacity: 0.9; font-weight: 400; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 8px;">
          * Nota: El c√°lculo de consumo acumulado y la visualizaci√≥n de datos se procesan en la ventana operativa de 08:00 a 00:00 h.
        </div>
      </div>

      <div id="modalLoader" class="loader"></div>
      <div id="modalStatus" style="font-style: italic; color: #666; margin-bottom: 10px; text-align: center; display: none;">Cargando datos...</div>
      
      <!-- Tabla paginada para KWH -->
      <div class="table-container" style="max-height: 350px; overflow-y: auto;">
        <table id="kwhHistoryTable">
          <thead>
            <tr><th>Fecha y Hora</th><th>Turno</th><th>Energ√≠a</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="kwhPagination" style="display: flex; justify-content: center; align-items: center; margin-top: 15px; gap: 10px;">
        <button id="btnKwhPrev" disabled>Anterior</button>
        <span id="pageKwhInfo">P√°gina 1 de 1</span>
        <button id="btnKwhNext" disabled>Siguiente</button>
      </div>
    </div>
  </div>

  <!-- Modal para Gr√°fico Slow Down STS1 -->
  <div id="slowDownModal" class="modal">
    <div class="modal-content" style="max-width: 1000px;">
      <div class="modal-header-custom">
        <h2 id="slowDownModalTitle">üìâ Gr√°fico Slow Down</h2>
        <span class="close-modal" onclick="closeSlowDownModal()">&times;</span>
      </div>
      <div class="modal-body-custom">
        <div style="display: flex; gap: 15px; align-items: flex-end; margin-bottom: 20px;">
          <div style="flex: 1;">
            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Seleccionar Fecha:</label>
            <input type="date" id="slowDownDateInput" style="padding: 8px; border-radius: 6px; border: 1px solid #ccc; width: 100%; font-size: 1rem;">
          </div>
          <button class="btn-calc" style="width: auto; padding: 0 25px;" onclick="requestSlowDownData()">Consultar</button>
        </div>
        <div id="slowDownAnalysis" style="background-color: #fff3cd; color: #856404; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; display: none; border: 1px solid #ffeeba;">
            <div style="font-size: 0.9rem; font-weight: 600; text-transform: uppercase; letter-spacing: 1px;">Tiempo Total en Slow Down</div>
            <div id="totalSlowDownTime" style="font-size: 1.8rem; font-weight: 800; margin-top: 5px;">--</div>
        </div>
        <div id="slowDownLoader" class="loader"></div>
        <div id="slowDownMsg" style="text-align: center; display: none; color: #666; margin-bottom: 10px;"></div>
        <div class="chart-container-modal" style="height: 400px; width: 100%;">
          <canvas id="slowDownChart"></canvas>
        </div>
        <div class="table-container" style="max-height: 300px; overflow-y: auto; margin-top: 20px;">
          <table id="slowDownTable" style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
            <thead style="position: sticky; top: 0; background-color: #fff; z-index: 1;">
              <tr style="background-color: var(--color-primary); color: #fff;">
                <th style="padding: 10px; text-align: left;">Fecha/Hora</th>
                <th style="padding: 10px; text-align: left;">Tipo</th>
                <th style="padding: 10px; text-align: left;">Estado</th>
                <th style="padding: 10px; text-align: left;">Evento</th>
                <th style="padding: 10px; text-align: left;">Duraci√≥n</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Contenedor de Notificaciones -->
  <div id="toast-container"></div>

<script src="script.js"></script>
</body>
</html>
