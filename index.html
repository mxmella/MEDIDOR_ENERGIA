<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Medidor de energía CGE</title>

  <!-- Chart.js + Zoom Plugin -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@1.2.1/dist/chartjs-plugin-zoom.min.js"></script>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter&display=swap');

    :root {
      --color-bg-light: #fff;
      --color-text-light: #333;
      --color-bg-dark: #2f2f2f;
      --color-text-dark: #dcdcdc;
      --color-primary: #0a3d66;
      --color-primary-light: #0a72c1;
      --color-accent: #ffc72c;
      --color-table-header-bg-light: var(--color-primary);
      --color-table-header-bg-dark: #444444;
    }

    body {
      background-color: var(--color-bg-light);
      color: var(--color-text-light);
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding: 30px 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      transition: background-color 0.4s ease, color 0.4s ease;
    }
    body.dark-mode {
      background-color: var(--color-bg-dark);
      color: var(--color-text-dark);
    }
    #logo-fijo {
      position: fixed;
      top: 15px;
      left: 15px;
      width: 150px;
      height: auto;
      z-index: 1000;
      filter: drop-shadow(0 0 5px rgba(0,0,0,0.1));
      transition: filter 0.4s ease;
    }
    body.dark-mode #logo-fijo {
      filter: drop-shadow(0 0 8px rgba(255, 199, 44, 0.9));
    }
    h1 {
      margin-top: 0;
      margin-bottom: 15px;
      color: var(--color-primary);
      font-weight: 700;
      font-size: 2.5rem;
      text-align: center;
      user-select: none;
      transition: color 0.4s ease;
    }
    body.dark-mode h1 {
      color: var(--color-accent);
    }
    canvas {
      background-color: #f5faff;
      border-radius: 12px;
      box-shadow: 0 0 15px rgba(10, 61, 102, 0.2);
      display: block;
      margin: 0 auto 25px auto;
      width: 900px !important;
      height: 450px !important;
      transition: background-color 0.4s ease;
    }
    body.dark-mode canvas {
      background-color: #3b3b3b;
      box-shadow: 0 0 25px rgba(255, 199, 44, 0.4);
    }
    #controls {
      text-align: center;
      margin-bottom: 20px;
    }
    #extraControls {
      text-align: center;
      margin-bottom: 20px;
      width: 900px;
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 10px;
    }
    input[type="text"], input[type="date"] {
      padding: 6px 12px;
      border-radius: 6px;
      border: 2px solid var(--color-primary);
      font-size: 1rem;
      outline: none;
      transition: border-color 0.3s ease;
      flex-grow: 1;
      max-width: 200px;
    }
    input[type="text"]:focus, input[type="date"]:focus {
      border-color: var(--color-primary-light);
    }
    button {
      background: none;
      border: 2px solid var(--color-primary);
      color: var(--color-primary);
      cursor: pointer;
      margin: 0 12px;
      padding: 8px;
      border-radius: 6px;
      transition: background-color 0.3s ease, color 0.3s ease;
      vertical-align: middle;
      min-width: 48px;
    }
    button:hover:not(:disabled) {
      background-color: var(--color-primary);
      color: #fff;
    }
    button:disabled {
      border-color: #bbb;
      color: #bbb;
      cursor: not-allowed;
      opacity: 0.7;
    }
    body.dark-mode button {
      border-color: var(--color-accent);
      color: var(--color-accent);
    }
    body.dark-mode button:hover:not(:disabled) {
      background-color: var(--color-accent);
      color: var(--color-bg-dark);
    }
    svg {
      width: 32px;
      height: 32px;
      fill: currentColor;
      user-select: none;
      vertical-align: middle;
    }
    table {
      width: 900px;
      border-collapse: separate;
      border-spacing: 0 8px;
      color: var(--color-text-light);
      font-size: 16px;
      box-shadow: 0 0 15px rgba(10, 61, 102, 0.15);
      border-radius: 12px;
      overflow: hidden;
      background: #fafcff;
      transition: background-color 0.4s ease, color 0.4s ease;
    }
    body.dark-mode table {
      background: #3b3b3b;
      color: var(--color-text-dark);
      box-shadow: 0 0 25px rgba(255, 199, 44, 0.4);
    }
    thead tr {
      background-color: var(--color-table-header-bg-light);
      color: #fff;
      text-align: left;
      user-select: none;
      transition: background-color 0.4s ease;
    }
    body.dark-mode thead tr {
      background-color: var(--color-table-header-bg-dark);
    }
    th, td {
      padding: 14px 20px;
    }
    tbody tr {
      background-color: #e6f0fc;
      transition: background-color 0.2s ease;
      border-radius: 10px;
      user-select: text;
    }
    body.dark-mode tbody tr {
      background-color: #545454;
    }
    tbody tr:hover {
      background-color: #c7dbf8;
    }
    body.dark-mode tbody tr:hover {
      background-color: #6f6f6f;
    }
    tbody tr td {
      border-bottom: none;
    }
    #pagination {
      width: 900px;
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 18px;
      color: var(--color-primary);
      font-size: 1rem;
      user-select: none;
      gap: 15px;
      transition: color 0.4s ease;
    }
    body.dark-mode #pagination {
      color: var(--color-accent);
    }
    #pageInfo {
      font-weight: 600;
      color: var(--color-primary);
      transition: color 0.4s ease;
    }
    body.dark-mode #pageInfo {
      color: var(--color-accent);
    }

    #connectionStatus {
      font-weight: 700;
      font-size: 1rem;
      margin-bottom: 15px;
      user-select: none;
      color: var(--color-primary);
      transition: color 0.4s ease;
    }
    body.dark-mode #connectionStatus {
      color: var(--color-accent);
    }

    #darkModeToggle {
      position: fixed;
      top: 15px;
      right: 15px;
      background: var(--color-primary);
      color: #fff;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      box-shadow: 0 0 10px rgba(10, 61, 102, 0.4);
      transition: background-color 0.3s ease;
      user-select: none;
      z-index: 1100;
    }
    #darkModeToggle:hover {
      background-color: var(--color-primary-light);
    }
    body.dark-mode #darkModeToggle {
      background: var(--color-accent);
      color: var(--color-bg-dark);
      box-shadow: 0 0 15px rgba(255, 199, 44, 0.7);
    }
    body.dark-mode #darkModeToggle:hover {
      background-color: #f4c320;
    }

    /* Alertas */
    #alertContainer {
      display:none; max-width:900px; margin: 0 auto 20px; padding:10px; border-radius:6px;
      background:#ff4c4c; color:#fff; font-weight:bold; text-align:center; font-size:1.2rem;
      user-select:none; box-shadow: 0 0 15px rgba(255,0,0,0.5);
    }
    #alertHistory {
      display:none; max-width:900px; margin: 0 auto 30px; background:#faf0f0; border:1px solid #ff4c4c;
      border-radius:6px; padding:10px; max-height: 150px; overflow-y: auto;
      font-family: monospace; font-size: 0.9rem; color:#900;
    }
    #toggleAlertsBtn {
      margin-bottom:15px; display:none; cursor:pointer; background:#0a3d66; color:#fff;
      padding:8px 14px; border:none; border-radius:6px; font-weight:600; user-select:none;
    }
    #toggleAlertsBtn:hover {
      background: #0a72c1;
    }
    body.dark-mode #alertHistory {
      background: #3b3b3b; color: #ff9999; border-color: #ff4c4c;
      box-shadow: 0 0 25px rgba(255, 199, 44, 0.4);
    }
    body.dark-mode #toggleAlertsBtn {
      background: var(--color-accent); color: var(--color-bg-dark);
      box-shadow: 0 0 15px rgba(255, 199, 44, 0.7);
    }
    body.dark-mode #toggleAlertsBtn:hover {
      background-color: #f4c320;
    }
  </style>
</head>
<body>
  <img id="logo-fijo" src="logo puerto.png" alt="Logo Puerto" />
  <button id="darkModeToggle" title="Alternar modo oscuro">Modo oscuro</button>

  <h1>Medidor de energía CGE</h1>

  <div id="connectionStatus">Estado: <span id="connText">Desconectado</span></div>

  <!-- Alertas -->
  <div id="alertContainer">⚠️ Alerta: Valor alto detectado!</div>
  <button id="toggleAlertsBtn">Mostrar Historial de Alertas</button>
  <div id="alertHistory"></div>

  <div id="extraControls">
    <input type="text" id="searchInput" placeholder="Buscar en tabla (fecha o valor)" title="Filtrar tabla en tiempo real" />
    <label for="dateFrom">Desde: </label><input type="date" id="dateFrom" />
    <label for="dateTo">Hasta: </label><input type="date" id="dateTo" />
    <button id="exportCsvBtn" title="Exportar tabla a CSV">Exportar CSV</button>
  </div>

  <canvas id="myChart" width="900" height="450"></canvas>

  <div id="controls">
    <button id="pauseBtn" title="Pausar">
      <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
        <rect x="6" y="5" width="4" height="14"></rect>
        <rect x="14" y="5" width="4" height="14"></rect>
      </svg>
    </button>
    <button id="playBtn" title="Reanudar" disabled>
      <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
        <polygon points="8,5 19,12 8,19"></polygon>
      </svg>
    </button>
    <button id="backBtn" title="Retroceder" style="display:none;">
      <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
        <polygon points="15,6 9,12 15,18"></polygon>
      </svg>
    </button>
    <button id="forwardBtn" title="Adelantar" style="display:none;">
      <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
        <polygon points="9,6 15,12 9,18"></polygon>
      </svg>
    </button>
    <button id="zoomToggle" title="Activar/Desactivar zoom">
      <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false" style="width:28px; height:28px;">
        <circle cx="11" cy="11" r="7" stroke="#0a3d66" stroke-width="2" fill="none"/>
        <line x1="16" y1="16" x2="21" y2="21" stroke="#0a3d66" stroke-width="2" />
      </svg>
    </button>
  </div>

  <table id="dataTable" tabindex="0" aria-label="Tabla de datos de medidor CGE">
    <thead>
      <tr>
        <th scope="col" data-sort="datetime" style="cursor:pointer;">Fecha y Hora &#x25B2;&#x25BC;</th>
        <th scope="col" data-sort="value" style="cursor:pointer;">Valor Medidor CGE</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div id="pagination">
    <button id="prevPage" disabled title="Anterior">
      <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
        <polygon points="15,6 9,12 15,18"></polygon>
      </svg>
    </button>
    <span id="pageInfo">Página 1 / 1</span>
    <button id="nextPage" disabled title="Siguiente">
      <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
        <polygon points="9,6 15,12 9,18"></polygon>
      </svg>
    </button>
  </div>

<script>
  // Modo oscuro persistente
  const bodyEl = document.body;
  const darkToggle = document.getElementById('darkModeToggle');
  const savedTheme = localStorage.getItem('theme');
  if(savedTheme === 'dark') {
    bodyEl.classList.add('dark-mode');
    darkToggle.textContent = 'Modo claro';
  }
  darkToggle.addEventListener('click', () => {
    bodyEl.classList.toggle('dark-mode');
    if(bodyEl.classList.contains('dark-mode')) {
      darkToggle.textContent = 'Modo claro';
      localStorage.setItem('theme', 'dark');
    } else {
      darkToggle.textContent = 'Modo oscuro';
      localStorage.setItem('theme', 'light');
    }
  });

  // MQTT y Chart.js con Zoom plugin
  const client = mqtt.connect('wss://mqtt-dashboard.com:8884/mqtt');
  const ctx = document.getElementById('myChart').getContext('2d');
  const connText = document.getElementById('connText');

  const data = {
    labels: [], 
    datasets: [{
      label: 'Medidor CGE (I Max)', 
      data: [],
      borderColor: '#0a72c1',
      backgroundColor: 'rgba(10, 114, 193, 0.3)',
      fill: true,
      tension: 0.3,
      pointRadius: 5,
      pointHoverRadius: 7,
      borderWidth: 3,
      hoverBorderWidth: 4
    }]
  };

  const config = {
    type: 'line',
    data: data,
    options: {
      animation: false,
      responsive: true,
      plugins: {
        legend: {
          labels: { color: getComputedStyle(document.body).getPropertyValue('--color-primary').trim() || '#0a3d66', font: { size: 16, weight: 'bold' } }
        },
        tooltip: {
          mode: 'index',
          intersect: false,
          backgroundColor: '#0a72c1',
          titleFont: { size: 16, weight: 'bold' },
          bodyFont: { size: 14 }
        },
        zoom: {
          pan: { enabled: false, mode: 'x' },
          zoom: { enabled: false, mode: 'x', wheel: { enabled: true }, pinch: { enabled: true } }
        }
      },
      scales: {
        x: {
          title: { display: true, text: 'Tiempo', color: getComputedStyle(document.body).getPropertyValue('--color-primary').trim() || '#0a3d66', font: { size: 18, weight: 'bold' } },
          ticks: { color: getComputedStyle(document.body).getPropertyValue('--color-primary').trim() || '#0a3d66', maxRotation: 45, minRotation: 30 },
          grid: { color: 'rgba(10, 61, 102, 0.15)' }
        },
        y: {
          title: { display: true, text: 'I Max', color: getComputedStyle(document.body).getPropertyValue('--color-primary').trim() || '#0a3d66', font: { size: 18, weight: 'bold' } },
          ticks: { color: getComputedStyle(document.body).getPropertyValue('--color-primary').trim() || '#0a3d66' },
          grid: { color: 'rgba(10, 61, 102, 0.15)' }
        }
      },
      interaction: {
        mode: 'nearest',
        axis: 'x',
        intersect: false
      }
    },
    plugins: [Chart.Zoom]
  };

  const myChart = new Chart(ctx, config);

  let paused = false;
  let allData = [];
  let viewIndex = -1;

  const pauseBtn = document.getElementById('pauseBtn');
  const playBtn = document.getElementById('playBtn');
  const backBtn = document.getElementById('backBtn');
  const forwardBtn = document.getElementById('forwardBtn');
  const zoomToggle = document.getElementById('zoomToggle');
  const searchInput = document.getElementById('searchInput');
  const exportCsvBtn = document.getElementById('exportCsvBtn');
  const dateFrom = document.getElementById('dateFrom');
  const dateTo = document.getElementById('dateTo');

  // Alertas
  const alertContainer = document.getElementById('alertContainer');
  const alertHistoryDiv = document.getElementById('alertHistory');
  const toggleAlertsBtn = document.getElementById('toggleAlertsBtn');
  let alertActive = false;
  let alertHistory = [];

  toggleAlertsBtn.addEventListener('click', () => {
    if(alertHistoryDiv.style.display === 'none') {
      alertHistoryDiv.style.display = 'block';
      toggleAlertsBtn.textContent = 'Ocultar Historial de Alertas';
    } else {
      alertHistoryDiv.style.display = 'none';
      toggleAlertsBtn.textContent = 'Mostrar Historial de Alertas';
    }
  });

  function addAlert(value, datetime) {
    const alertText = `Alerta en ${datetime}: valor = ${value.toFixed(2)}`;
    alertHistory.push(alertText);
    alertHistoryDiv.innerHTML = alertHistory.map(a => `<div>${a}</div>`).join('');
    toggleAlertsBtn.style.display = 'inline-block';

    alertContainer.style.display = 'block';
    alertContainer.textContent = `⚠️ Alerta: Valor alto detectado! Valor actual: ${value.toFixed(2)}`;

    setTimeout(() => {
      if(alertActive) return;
      alertContainer.style.display = 'none';
    }, 5000);
  }

  pauseBtn.addEventListener('click', () => {
    paused = true;
    pauseBtn.disabled = true;
    playBtn.disabled = false;
    backBtn.style.display = 'inline-block';
    forwardBtn.style.display = 'inline-block';
    zoomToggle.disabled = true;
    viewIndex = data.labels.length - 1;
    updateGraphView();
  });

  playBtn.addEventListener('click', () => {
    paused = false;
    pauseBtn.disabled = false;
    playBtn.disabled = true;
    backBtn.style.display = 'none';
    forwardBtn.style.display = 'none';
    zoomToggle.disabled = false;
    updateGraphView();
  });

  backBtn.addEventListener('click', () => {
    if(viewIndex > 19) {
      viewIndex--;
      updateGraphView();
      updateBackForwardButtons();
    }
  });

  forwardBtn.addEventListener('click', () => {
    if(viewIndex < data.labels.length - 1) {
      viewIndex++;
      updateGraphView();
      updateBackForwardButtons();
    }
  });

  zoomToggle.addEventListener('click', () => {
    const zoomPlugin = myChart.getPlugin('zoom');
    const enabled = zoomPlugin._enabled || false;
    if(enabled) {
      zoomPlugin.disable();
      zoomToggle.style.backgroundColor = 'transparent';
    } else {
      zoomPlugin.enable();
      zoomToggle.style.backgroundColor = 'var(--color-primary)';
    }
  });

  function updateBackForwardButtons() {
    backBtn.disabled = viewIndex <= 19;
    forwardBtn.disabled = viewIndex >= data.labels.length - 1;
  }

  function updateGraphView(){
    if(!paused){
      const lastLabels = data.labels.slice(-20);
      const lastData = data.datasets[0].data.slice(-20);
      myChart.data.labels = lastLabels;
      myChart.data.datasets[0].data = lastData;
    } else {
      const start = Math.max(0, viewIndex - 19);
      const end = viewIndex + 1;
      myChart.data.labels = data.labels.slice(start, end);
      myChart.data.datasets[0].data = data.datasets[0].data.slice(start, end);
    }
    myChart.update();
    updateBackForwardButtons();
  }

  client.on('connect', () => {
    console.log('Conectado al broker MQTT');
    connText.textContent = 'Conectado';
    client.subscribe('MEDIDOR_CGE');
  });

  client.on('reconnect', () => {
    connText.textContent = 'Reconectando...';
  });

  client.on('close', () => {
    connText.textContent = 'Desconectado';
  });

  client.on('error', (err) => {
    console.error('Error MQTT:', err);
    connText.textContent = 'Error de conexión';
  });

  client.on('message', (topic, message) => {
    if (topic === 'MEDIDOR_CGE') {
      const value = parseFloat(message.toString());
      if (!isNaN(value)) {
        const now = new Date();
        const timeLabel = now.toLocaleTimeString();
        const fullDate = now.toLocaleString();

        allData.push({datetime: fullDate, value: value});
        if(allData.length > 1000) allData.shift();

        applyFiltersAndRender();

        // Alertas
        const threshold = 80;
        if(value > threshold) {
          alertActive = true;
          addAlert(value, fullDate);
        } else {
          alertActive = false;
          alertContainer.style.display = 'none';
        }
      }
    }
  });

  const tableBody = document.querySelector('#dataTable tbody');
  const prevPageBtn = document.getElementById('prevPage');
  const nextPageBtn = document.getElementById('nextPage');
  const pageInfo = document.getElementById('pageInfo');
  const rowsPerPage = 10;
  let currentPage = 1;

  let filteredData = [];

  function applyFiltersAndRender() {
    let tempData = [...allData];

    const searchTerm = searchInput.value.trim().toLowerCase();
    if(searchTerm !== '') {
      tempData = tempData.filter(item => 
        item.datetime.toLowerCase().includes(searchTerm) || 
        item.value.toString().includes(searchTerm)
      );
    }

    if(dateFrom.value) {
      const fromDate = new Date(dateFrom.value);
      tempData = tempData.filter(item => new Date(item.datetime) >= fromDate);
    }

    if(dateTo.value) {
      const toDate = new Date(dateTo.value);
      toDate.setHours(23,59,59,999);
      tempData = tempData.filter(item => new Date(item.datetime) <= toDate);
    }

    filteredData = tempData;
    currentPage = 1;

    renderTablePage(currentPage);
    updatePaginationButtons();

    if(!paused){
      updateChartWithFilteredData();
    }
  }

  function updateChartWithFilteredData() {
    const len = filteredData.length;
    const lastItems = filteredData.slice(Math.max(0, len - 20), len);

    data.labels = lastItems.map(item => new Date(item.datetime).toLocaleTimeString());
    data.datasets[0].data = lastItems.map(item => item.value);

    myChart.update();
  }

  function renderTablePage(page) {
    tableBody.innerHTML = '';
    const start = (page - 1) * rowsPerPage;
    const end = start + rowsPerPage;
    const pageData = filteredData.slice(start, end);
    for (const row of pageData) {
      const tr = document.createElement('tr');
      const tdDate = document.createElement('td');
      const tdValue = document.createElement('td');
      tdDate.textContent = row.datetime;
      tdValue.textContent = row.value.toFixed(2);
      tr.appendChild(tdDate);
      tr.appendChild(tdValue);
      tableBody.appendChild(tr);
    }
    const totalPages = Math.min(1000, Math.max(1, Math.ceil(filteredData.length / rowsPerPage)));
    pageInfo.textContent = `Página ${currentPage} / ${totalPages}`;
  }

  function updatePaginationButtons() {
    const totalPages = Math.min(1000, Math.max(1, Math.ceil(filteredData.length / rowsPerPage)));
    prevPageBtn.disabled = currentPage === 1;
    nextPageBtn.disabled = currentPage === totalPages;
  }

  prevPageBtn.addEventListener('click', () => {
    if (currentPage > 1) {
      currentPage--;
      renderTablePage(currentPage);
      updatePaginationButtons();
    }
  });

  nextPageBtn.addEventListener('click', () => {
    if (currentPage * rowsPerPage < filteredData.length) {
      currentPage++;
      renderTablePage(currentPage);
      updatePaginationButtons();
    }
  });

  searchInput.addEventListener('input', () => {
    applyFiltersAndRender();
  });

  dateFrom.addEventListener('change', () => {
    applyFiltersAndRender();
  });

  dateTo.addEventListener('change', () => {
    applyFiltersAndRender();
  });

  exportCsvBtn.addEventListener('click', () => {
    let csvContent = "data:text/csv;charset=utf-8,";
    csvContent += "Fecha y Hora,Valor Medidor CGE\n";
    filteredData.forEach(row => {
      csvContent += `"${row.datetime}","${row.value.toFixed(2)}"\n`;
    });

    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "medidor_cge_datos.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  });

  // Inicializar filtros y mostrar todo inicialmente
  filteredData = [...allData];
  applyFiltersAndRender();
</script>
</body>
</html>

